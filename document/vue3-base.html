<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 简介 | DataFan UI</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="所有的伟大，都源于一个勇敢的开始">
    
    <link rel="preload" href="/assets/css/0.styles.abab0079.css" as="style"><link rel="preload" href="/assets/js/app.49d1029a.js" as="script"><link rel="preload" href="/assets/js/2.2784263e.js" as="script"><link rel="preload" href="/assets/js/39.9ec52d5d.js" as="script"><link rel="prefetch" href="/assets/js/10.6f6894d4.js"><link rel="prefetch" href="/assets/js/11.70a5ddb8.js"><link rel="prefetch" href="/assets/js/12.911e997c.js"><link rel="prefetch" href="/assets/js/13.9d1b7f91.js"><link rel="prefetch" href="/assets/js/14.009ac787.js"><link rel="prefetch" href="/assets/js/15.fd8378a0.js"><link rel="prefetch" href="/assets/js/16.dd26dbe5.js"><link rel="prefetch" href="/assets/js/17.51850043.js"><link rel="prefetch" href="/assets/js/18.e6e5543e.js"><link rel="prefetch" href="/assets/js/19.7ea3c23e.js"><link rel="prefetch" href="/assets/js/20.f1cf9eeb.js"><link rel="prefetch" href="/assets/js/21.f8c52346.js"><link rel="prefetch" href="/assets/js/22.758b3ec0.js"><link rel="prefetch" href="/assets/js/23.67a7a48f.js"><link rel="prefetch" href="/assets/js/24.2310a5b4.js"><link rel="prefetch" href="/assets/js/25.4d17caa8.js"><link rel="prefetch" href="/assets/js/26.050d59df.js"><link rel="prefetch" href="/assets/js/27.e2350965.js"><link rel="prefetch" href="/assets/js/28.375f7b56.js"><link rel="prefetch" href="/assets/js/29.3cea99ae.js"><link rel="prefetch" href="/assets/js/3.30e359b9.js"><link rel="prefetch" href="/assets/js/30.ea700635.js"><link rel="prefetch" href="/assets/js/31.f1d4d465.js"><link rel="prefetch" href="/assets/js/32.0b2beb0a.js"><link rel="prefetch" href="/assets/js/33.5b864d31.js"><link rel="prefetch" href="/assets/js/34.3ebd8617.js"><link rel="prefetch" href="/assets/js/35.b83c85b9.js"><link rel="prefetch" href="/assets/js/36.5743c567.js"><link rel="prefetch" href="/assets/js/37.16584230.js"><link rel="prefetch" href="/assets/js/38.b036bcdf.js"><link rel="prefetch" href="/assets/js/4.4115b534.js"><link rel="prefetch" href="/assets/js/40.1bc3f5b7.js"><link rel="prefetch" href="/assets/js/41.52820797.js"><link rel="prefetch" href="/assets/js/5.430e0c7a.js"><link rel="prefetch" href="/assets/js/6.9617d452.js"><link rel="prefetch" href="/assets/js/7.dc8a3d69.js"><link rel="prefetch" href="/assets/js/8.bb5f4b4c.js"><link rel="prefetch" href="/assets/js/9.f8dd7230.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abab0079.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DataFan UI</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/components/" class="nav-link">
  组件中心
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  规范文档
</a></div><div class="nav-item"><a href="/document/" class="nav-link router-link-active">
  开发手册
</a></div><div class="nav-item"><a href="https://github.com/young-datafan/datafan-ui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/components/" class="nav-link">
  组件中心
</a></div><div class="nav-item"><a href="/design/" class="nav-link">
  规范文档
</a></div><div class="nav-item"><a href="/document/" class="nav-link router-link-active">
  开发手册
</a></div><div class="nav-item"><a href="https://github.com/young-datafan/datafan-ui" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/document/" aria-current="page" class="sidebar-link">开发手册</a></li><li><a href="/document/vue3/" class="sidebar-link">Vue3 新框架&amp;组件</a></li><li><a href="/document/pinia.html" class="sidebar-link">Pinia 新一代状态管理</a></li><li><a href="/document/TypeScript.html" class="sidebar-link">TypeScript</a></li><li><a href="/document/vue3-base.html" aria-current="page" class="active sidebar-link">Vue3 基础知识</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#vue3-简介" class="sidebar-link">Vue3 简介</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#vue3-带来了什么" class="sidebar-link">Vue3 带来了什么</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#性能的提升" class="sidebar-link">性能的提升</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#源码的升级" class="sidebar-link">源码的升级</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#拥抱-typescript" class="sidebar-link">拥抱 TypeScript</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#创建-vue3-0-工程" class="sidebar-link">创建 Vue3.0 工程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#使用-vue-cli-创建" class="sidebar-link">使用 vue-cli 创建</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#使用-vite-创建" class="sidebar-link">使用 vite 创建</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#setup" class="sidebar-link">setup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#基本语法" class="sidebar-link">基本语法</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#setup-的两个注意点" class="sidebar-link">setup 的两个注意点</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#了解-definecomponent" class="sidebar-link">了解 defineComponent</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#script-setup" class="sidebar-link">script-setup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#新特性的产生背景" class="sidebar-link">新特性的产生背景</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#全局编译器宏" class="sidebar-link">全局编译器宏</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#template-操作简化" class="sidebar-link">template 操作简化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#props-的接收方式变化" class="sidebar-link">props 的接收方式变化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#emits-的接收方式变化" class="sidebar-link">emits 的接收方式变化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#attrs-的接收方式变化" class="sidebar-link">attrs 的接收方式变化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#slots-的接收方式变化" class="sidebar-link">slots 的接收方式变化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#ref-的通信方式变化" class="sidebar-link">ref 的通信方式变化</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#组件的生命周期" class="sidebar-link">组件的生命周期</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#vue3-0-中的响应式原理" class="sidebar-link">Vue3.0 中的响应式原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#vue2-x-的响应式" class="sidebar-link">vue2.x 的响应式</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#vue3-0-的响应式" class="sidebar-link">Vue3.0 的响应式</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#响应式-api-之-ref" class="sidebar-link">响应式 API 之 ref</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#类型声明" class="sidebar-link">类型声明</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#变量的定义" class="sidebar-link">变量的定义</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#dom-元素与子组件" class="sidebar-link">DOM 元素与子组件</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#变量的读取与赋值" class="sidebar-link">变量的读取与赋值</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#响应式-api-之-reactive" class="sidebar-link">响应式 API 之 reactive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#类型声明与定义" class="sidebar-link">类型声明与定义</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#变量的读取与赋值-2" class="sidebar-link">变量的读取与赋值</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#特别注意" class="sidebar-link">特别注意</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#响应式-api-之-toref-与-torefs" class="sidebar-link">响应式 API 之 toRef 与 toRefs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#各自的作用" class="sidebar-link">各自的作用</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#使用-toref" class="sidebar-link">使用 toRef</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#使用-torefs" class="sidebar-link">使用 toRefs</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#为什么要进行转换" class="sidebar-link">为什么要进行转换</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#什么场景下比较适合使用它们" class="sidebar-link">什么场景下比较适合使用它们</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#在业务中的具体运用" class="sidebar-link">在业务中的具体运用</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#需要注意的问题" class="sidebar-link">需要注意的问题</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#其它响应式api" class="sidebar-link">其它响应式API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#readonly" class="sidebar-link">readonly()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#isref" class="sidebar-link">isRef()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#unref" class="sidebar-link">unref()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#isproxy" class="sidebar-link">isProxy()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#isreactive" class="sidebar-link">isReactive()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#isreactive-2" class="sidebar-link">isReactive()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#shallowref" class="sidebar-link">shallowRef()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#triggerref" class="sidebar-link">triggerRef()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#shallowreactive" class="sidebar-link">shallowReactive()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#shallowreadonly" class="sidebar-link">shallowReadonly()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#toraw" class="sidebar-link">toRaw()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#markraw" class="sidebar-link">markRaw()</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#customref" class="sidebar-link">customRef()</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#自定义-hook-函数" class="sidebar-link">自定义 hook 函数</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#数据的监听" class="sidebar-link">数据的监听</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#watch" class="sidebar-link">watch</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#watcheffect" class="sidebar-link">watchEffect</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#watchposteffect" class="sidebar-link">watchPostEffect</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#watchsynceffect" class="sidebar-link">watchSyncEffect</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#数据的计算" class="sidebar-link">数据的计算</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#用法变化" class="sidebar-link">用法变化</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#类型定义" class="sidebar-link">类型定义</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#优势对比和注意事项" class="sidebar-link">优势对比和注意事项</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#setter-的使用" class="sidebar-link">setter 的使用</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#css-样式与预处理器" class="sidebar-link">CSS 样式与预处理器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#编写组件样式表" class="sidebar-link">编写组件样式表</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#动态绑定-css" class="sidebar-link">动态绑定 CSS</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#样式表的组件作用域" class="sidebar-link">样式表的组件作用域</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#深度操作符" class="sidebar-link">深度操作符</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#组件之间的通信" class="sidebar-link">组件之间的通信</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#父子组件通信" class="sidebar-link">父子组件通信</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#props-emits" class="sidebar-link">props / emits</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#下发-props" class="sidebar-link">下发 props</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#接收-props" class="sidebar-link">接收 props</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#带有类型限制的-props" class="sidebar-link">带有类型限制的 props</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#可选以及带有默认值的-props" class="sidebar-link">可选以及带有默认值的 props</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#使用-props" class="sidebar-link">使用 props</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#传递非-prop-的-attribute" class="sidebar-link">传递非 Prop 的 Attribute</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#获取非-prop-的-attribute" class="sidebar-link">获取非 Prop 的 Attribute</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#绑定-emits" class="sidebar-link">绑定 emits</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#接收-emits" class="sidebar-link">接收 emits</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#接收-emits-时做一些校验" class="sidebar-link">接收 emits 时做一些校验</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#调用-emits" class="sidebar-link">调用 emits</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#v-model-emits" class="sidebar-link">v-model / emits</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#绑定-v-model" class="sidebar-link">绑定 v-model</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#配置-emits" class="sidebar-link">配置 emits</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#调用自身的-emits" class="sidebar-link">调用自身的 emits</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#ref-emits" class="sidebar-link">ref / emits</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#父组件操作子组件" class="sidebar-link">父组件操作子组件</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#子组件通知父组件" class="sidebar-link">子组件通知父组件</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#爷孙组件通信" class="sidebar-link">爷孙组件通信</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#provide-inject" class="sidebar-link">provide / inject</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#发起-provide" class="sidebar-link">发起 provide</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#接收-inject" class="sidebar-link">接收 inject</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#响应性数据的传递与接收" class="sidebar-link">响应性数据的传递与接收</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#引用类型的传递与接收" class="sidebar-link">引用类型的传递与接收</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#基本类型的传递与接收" class="sidebar-link">基本类型的传递与接收</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#兄弟组件通信" class="sidebar-link">兄弟组件通信</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#全局组件通信" class="sidebar-link">全局组件通信</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#eventbus" class="sidebar-link">EventBus</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/document/vue3-base.html#回顾-vue-2-3" class="sidebar-link">回顾 Vue 2</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#了解-vue-3-3" class="sidebar-link">了解 Vue 3</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#创建-3-x-的-eventbus" class="sidebar-link">创建 3.x 的 EventBus</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#创建和移除监听事件" class="sidebar-link">创建和移除监听事件</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#调用监听事件" class="sidebar-link">调用监听事件</a></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#旧项目升级-eventbus" class="sidebar-link">旧项目升级 EventBus</a></li></ul></li><li class="sidebar-sub-header"><a href="/document/vue3-base.html#全局-api-的转移" class="sidebar-link">全局 API 的转移</a></li></ul></li><li><a href="/document/x6/" class="sidebar-link">antv-X6</a></li><li><a href="/document/Promise/" class="sidebar-link">Promise对象</a></li><li><a href="/document/Closure/" class="sidebar-link">闭包和Http缓存机制</a></li><li><a href="/document/vue3-unti-test.html" class="sidebar-link">Vue3 单元测试</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="vue3-简介"><a href="#vue3-简介" class="header-anchor">#</a> Vue3 简介</h2> <ul><li>2020 年 9 月 18 日，Vue.js 发布 3.0 版本，代号：One Piece（海贼王）</li> <li>耗时 2 年多、<a href="https://github.com/vuejs/vue-next/graphs/commit-activity" target="_blank" rel="noopener noreferrer">2600+次提交<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/vuejs/rfcs/tree/master/active-rfcs" target="_blank" rel="noopener noreferrer">30+个 RFC<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/vuejs/vue-next/pulls?q=is%3Apr+is%3Amerged+-author%3Aapp%2Fdependabot-preview+" target="_blank" rel="noopener noreferrer">600+次 PR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/vuejs/vue-next/graphs/contributors" target="_blank" rel="noopener noreferrer">99 位贡献者<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>github 上的 tags 地址：https://github.com/vuejs/vue-next/releases/tag/v3.0.0</li></ul> <h2 id="vue3-带来了什么"><a href="#vue3-带来了什么" class="header-anchor">#</a> Vue3 带来了什么</h2> <h3 id="性能的提升"><a href="#性能的提升" class="header-anchor">#</a> 性能的提升</h3> <ul><li><p>打包大小减少 41%</p></li> <li><p>初次渲染快 55%, 更新渲染快 133%</p></li> <li><p>内存减少 54%</p> <p>......</p></li></ul> <h3 id="源码的升级"><a href="#源码的升级" class="header-anchor">#</a> 源码的升级</h3> <ul><li><p>使用 Proxy 代替 defineProperty 实现响应式</p></li> <li><p>重写虚拟 DOM 的实现和 Tree-Shaking</p> <p>......</p></li></ul> <h3 id="拥抱-typescript"><a href="#拥抱-typescript" class="header-anchor">#</a> 拥抱 TypeScript</h3> <ul><li>Vue3 可以更好的支持 TypeScript</li></ul> <h2 id="创建-vue3-0-工程"><a href="#创建-vue3-0-工程" class="header-anchor">#</a> 创建 Vue3.0 工程</h2> <h3 id="使用-vue-cli-创建"><a href="#使用-vue-cli-创建" class="header-anchor">#</a> 使用 vue-cli 创建</h3> <p>官方文档：https://cli.vuejs.org/zh/guide/creating-a-project.html#vue-create</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 查看@vue/cli版本，确保@vue/cli版本在4.5.0以上</span>
vue --version
<span class="token comment">## 安装或者升级你的@vue/cli</span>
<span class="token function">npm</span> <span class="token function">install</span> -g @vue/cli
<span class="token comment">## 创建</span>
vue create vue_test
<span class="token comment">## 启动</span>
<span class="token builtin class-name">cd</span> vue_test
<span class="token function">npm</span> run serve
</code></pre></div><h3 id="使用-vite-创建"><a href="#使用-vite-创建" class="header-anchor">#</a> 使用 vite 创建</h3> <p>官方文档：https://v3.cn.vuejs.org/guide/installation.html#vite</p> <p>vite 官网：https://vitejs.cn</p> <ul><li>什么是 vite？—— 新一代前端构建工具。</li> <li>优势如下：
<ul><li>开发环境中，无需打包操作，可快速的冷启动。</li> <li>轻量快速的热重载（HMR）。</li> <li>真正的按需编译，不再等待整个应用编译完成。</li></ul></li> <li>传统构建 与 vite 构建对比图</li></ul> <p><img src="https://cn.vitejs.dev/assets/bundler.37740380.png" style="width:500px;height:280px;float:left;"><img src="https://cn.vitejs.dev/assets/esm.3070012d.png" style="width:480px;height:280px;"></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">## 创建工程</span>
<span class="token function">npm</span> init vite-app <span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>
<span class="token function">yarn</span> create vite <span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span> --template vue-ts
<span class="token comment">## 进入工程目录</span>
<span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>project-name<span class="token operator">&gt;</span>
<span class="token comment">## 安装依赖</span>
<span class="token function">npm</span> <span class="token function">install</span>
<span class="token comment">## 运行</span>
<span class="token function">npm</span> run dev
</code></pre></div><h2 id="setup"><a href="#setup" class="header-anchor">#</a> setup</h2> <h3 id="基本语法"><a href="#基本语法" class="header-anchor">#</a> 基本语法</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 业务代码写这里...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要给 template 用的数据、函数放这里 return 出去...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里我还写了一个 <code>defineComponent</code>，也是本次的新东西，可以点击 <a href="#%E4%BA%86%E8%A7%A3-definecomponent">了解 defineComponent</a> 。</p> <h3 id="setup-的两个注意点"><a href="#setup-的两个注意点" class="header-anchor">#</a> setup 的两个注意点</h3> <ul><li><p>setup 执行的时机</p> <ul><li>在 beforeCreate 之前执行一次</li></ul></li> <li><p>setup 的参数</p> <ul><li>props：值为对象，包含：组件外部传递过来，且组件内部声明接收了的属性。</li> <li>context：上下文对象
<ul><li>attrs: 值为对象，包含：组件外部传递过来，但没有在 props 配置中声明的属性, 相当于 <code>this.$attrs</code>。</li> <li>slots: 收到的插槽内容, 相当于 <code>this.$slots</code>。</li> <li>emit: 分发自定义事件的函数, 相当于 <code>this.$emit</code>。</li></ul></li></ul></li></ul> <h3 id="了解-definecomponent"><a href="#了解-definecomponent" class="header-anchor">#</a> 了解 defineComponent</h3> <p>这是 Vue 3 推出的一个全新 API ，defineComponent 可以用于 TypeScript 的类型推导，帮你简化掉很多编写过程中的类型定义。</p> <p>比如，你原本需要这样才可以使用 setup 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Slots <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 声明 props 和 return 的数据类型</span>
<span class="token keyword">interface</span> <span class="token class-name">Data</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> unknown
<span class="token punctuation">}</span>

<span class="token comment">// 声明 context 的类型</span>
<span class="token keyword">interface</span> <span class="token class-name">SetupContext</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">attrs</span><span class="token operator">:</span> Data
  <span class="token literal-property property">slots</span><span class="token operator">:</span> Slots
  <span class="token function-variable function">emit</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token operator">:</span> unknown<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用的时候入参要加上声明， return 也要加上声明</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token operator">:</span> Data<span class="token punctuation">,</span> <span class="token literal-property property">context</span><span class="token operator">:</span> SetupContext<span class="token punctuation">)</span><span class="token operator">:</span> Data <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用了 defineComponent 之后，你就可以省略这些类型定义：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>只要是 Vue 本身的 API ，defineComponent 都可以自动帮你推导。
在编写组件的过程中，你只需要维护自己定义的数据类型就可以了，专注于业务。</p> <h2 id="script-setup"><a href="#script-setup" class="header-anchor">#</a> script-setup</h2> <p>这是一个比较有争议的新特性，作为 setup 函数的语法糖，褒贬不一，不过经历了几次迭代之后，目前在体验上来说，感受还是非常棒的。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>截止至 2021-07-16 ，<code>&lt;script setup&gt;</code> 方案已在 Vue <code>3.2.0-beta.1</code> 版本中脱离实验状态，正式进入 Vue 3.0 的队伍，在新的版本中已经可以作为一个官方标准的开发方案使用（但初期仍需注意与开源社区的项目兼容性问题，特别是 UI 框架）。</p> <p>另外，Vue 的 <code>3.1.2</code> 版本是针对 script-setup 的一个分水岭版本，自 <code>3.1.4</code> 开始 script-setup 进入定稿状态，部分旧的 API 已被舍弃，本章节内容将以最新的 API 为准进行整理说明，如果您需要查阅旧版 API 的使用，请参阅 <a href="https://chengpeiquan.com/article/vue3-script-setup.html" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p></div> <h3 id="新特性的产生背景"><a href="#新特性的产生背景" class="header-anchor">#</a> 新特性的产生背景</h3> <p>在了解它怎么用之前，可以先了解一下它被推出的一些背景，可以帮助你对比开发体验上的异同点，以及了解为什么会有这一章节里面的新东西。</p> <p>在 Vue 3.0 的 .vue 组件里，遵循 SFC 规范要求（注：SFC，即 Single-File Component，.vue 单组件），标准的 setup 用法是，在 setup 里面定义的数据如果需要在 template 使用，都需要 return 出来。</p> <p>如果你使用的是 TypeScript ，还需要借助 <a href="/document/component.html#了解-definecomponent">defineComponent</a> 来帮助你对类型的自动推导。</p> <p>script-setup 的推出是为了让熟悉 3.0 的用户可以更高效率的开发组件，减少一些心智负担，只需要给 script 标签添加一个 setup 属性，那么整个 script 就直接会变成 setup 函数，所有顶级变量、函数，均会自动暴露给模板使用（无需再一个个 return 了）。</p> <p>Vue 会通过单组件编译器，在编译的时候将其处理回标准组件，所以目前这个方案只适合用 .vue 文件写的工程化项目。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 使用 script-setup 格式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
  <span class="token comment">// ...</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对，就是这样，代码量瞬间大幅度减少……</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>因为 script-setup 的大部分功能在书写上和标准版是一致的，这里只提及一些差异化的表现。</p></div> <h3 id="全局编译器宏"><a href="#全局编译器宏" class="header-anchor">#</a> 全局编译器宏</h3> <p>在 script-setup 模式下，新增了 4 个全局编译器宏，他们无需 import 就可以直接使用。</p> <table><thead><tr><th style="text-align:center;">宏</th> <th style="text-align:center;">说明</th></tr></thead> <tbody><tr><td style="text-align:center;">defineProps</td> <td style="text-align:center;"><a href="#defineprops-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">点击查看</a></td></tr> <tr><td style="text-align:center;">defineEmits</td> <td style="text-align:center;"><a href="#defineemits-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">点击查看</a></td></tr> <tr><td style="text-align:center;">defineExpose</td> <td style="text-align:center;"><a href="#defineexpose-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">点击查看</a></td></tr> <tr><td style="text-align:center;">withDefaults</td> <td style="text-align:center;"><a href="#withdefaults-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">点击查看</a></td></tr></tbody></table> <p>下面我们继续了解 script-setup 的变化。</p> <h3 id="template-操作简化"><a href="#template-操作简化" class="header-anchor">#</a> template 操作简化</h3> <p>主要体现在这两点：</p> <h4 id="变量无需进行-return"><a href="#变量无需进行-return" class="header-anchor">#</a> 变量无需进行 return</h4> <p>标准组件模式下，setup 里定义的变量，需要 return 后，在 template 部分才可以正确拿到：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 标准组件格式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 要给 template 用的数据需要 return 出来才可以</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在 script-setup 模式下，你定义了就可以直接使用。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 使用 script-setup 格式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{ msg }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">const</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="子组件无需手动注册"><a href="#子组件无需手动注册" class="header-anchor">#</a> 子组件无需手动注册</h4> <p>子组件的挂载，在标准组件里的写法是需要 import 后再放到 components 里才能够启用：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 标准组件格式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 导入子组件</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'@cp/Child.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 需要启用子组件作为模板</span>
  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 组件里的业务代码</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在 script-setup 模式下，只需要导入组件即可，编译器会自动识别并启用。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token comment">&lt;!-- 使用 script-setup 格式 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'./components/Child.vue'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="props-的接收方式变化"><a href="#props-的接收方式变化" class="header-anchor">#</a> props 的接收方式变化</h3> <p>由于整个 script 都变成了一个大的 setup function ，没有了组件选项，也没有了 setup 入参，所以没办法和标准写法一样去接收 props 了。</p> <p>这里需要使用一个全新的 API ：<code>defineProps</code> 。</p> <p><code>defineProps</code> 是一个方法，内部返回一个对象，也就是挂载到这个组件上的所有 props ，它和普通的 props 用法一样，如果不指定为 prop， 则传下来的属性会被放到 attrs 那边去。</p> <h4 id="defineprops-的基础用法"><a href="#defineprops-的基础用法" class="header-anchor">#</a> defineProps 的基础用法</h4> <p>所以，如果只是单纯在 template 里使用，那么其实就这么简单定义就可以了：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'name'</span><span class="token punctuation">,</span>
  <span class="token string">'userInfo'</span><span class="token punctuation">,</span>
  <span class="token string">'tags'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>使用 <code>string[]</code> 数组作为入参，把 prop 的名称作为数组的 item 传给 <code>defineProps</code> 就可以了。</p> <p>如果 script 里的方法要拿到 props 的值，你也可以使用字面量定义：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token string">'name'</span><span class="token punctuation">,</span>
  <span class="token string">'userInfo'</span><span class="token punctuation">,</span>
  <span class="token string">'tags'</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但在作为一个 Vue 老玩家，都清楚不显性的指定 prop 类型的话，很容易在协作中引起程序报错，那么应该如何对每个 prop 进行类型检查呢？</p> <p>有两种方式来处理类型定义。</p> <h4 id="通过构造函数检查-prop"><a href="#通过构造函数检查-prop" class="header-anchor">#</a> 通过构造函数检查 prop</h4> <p>这是第一种方式：使用 JavaScript 原生构造函数进行类型规定。</p> <p>也就是跟我们平时定义 prop 类型时一样， Vue 会通过 <code>instanceof</code> 来进行 <a href="https://v3.cn.vuejs.org/guide/component-props.html#%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%9F%A5" target="_blank" rel="noopener noreferrer">类型检查<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <p>使用这种方法，需要通过一个 “对象” 入参来传递给 <code>defineProps</code> ，比如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  userInfo<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  tags<span class="token operator">:</span> <span class="token builtin">Array</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>所有原来 props 具备的校验机制，都可以适用，比如你除了要限制类型外，还想指定 <code>name</code> 是可选，并且带有一个默认值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">defineProps</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'Petter'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  userInfo<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  tags<span class="token operator">:</span> <span class="token builtin">Array</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="使用类型注解检查-prop"><a href="#使用类型注解检查-prop" class="header-anchor">#</a> 使用类型注解检查 prop</h4> <p>这是第二种方式：使用 TypeScript 的类型注解。</p> <p>和 ref 等 API 的用法一样，<code>defineProps</code> 也是可以使用尖括号 &lt;&gt; 来包裹类型定义，紧跟在 API 后面，另外，由于 <code>defineProps</code> 返回的是一个对象（因为 props 本身是一个对象），所以尖括号里面的类型还要用大括号包裹，通过 <code>key: value</code> 的键值对形式表示，如：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意到了吗？这里使用的类型，和第一种方法提到的指定类型时是不一样的。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在这里，不再使用构造函数校验，而是需要遵循使用 TypeScript 的类型。</p> <p>比如字符串是 <code>string</code>，而不是 <code>String</code> 。</p></div> <p>如果有多个 prop ，就跟写 interface 一样：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  phoneNumber<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  userInfo<span class="token operator">:</span> object<span class="token punctuation">;</span>
  tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>其中，举例里的 <code>userInfo</code> 是一个对象，你可以简单的指定为 object，也可以先定义好它对应的类型，再进行指定：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  userInfo<span class="token operator">:</span> UserInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果你想对某个数据设置为可选，也是遵循 TS 规范，通过英文问号 <code>?</code> 来允许可选：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// name 是可选</span>
<span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{</span>
  name<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果你想设置可选参数的默认值，需要借助 <a href="#withdefaults-%E7%9A%84%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">withDefaults</a> API。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>需要强调的一点是：在 <a href="#%E9%80%9A%E8%BF%87%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E6%A3%80%E6%9F%A5-prop">构造函数</a> 和 <a href="#%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%9E%8B%E6%B3%A8%E8%A7%A3%E6%A3%80%E6%9F%A5-prop">类型注解</a> 这两种校验方式只能二选一，不能同时使用，否则会引起程序报错</p></div> <h4 id="withdefaults-的基础用法"><a href="#withdefaults-的基础用法" class="header-anchor">#</a> withDefaults 的基础用法</h4> <p>这个新的 withDefaults API 可以让你在使用 TS 类型系统时，也可以指定 props 的默认值。</p> <p>它接收两个入参：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">props</td> <td style="text-align:left;">object</td> <td style="text-align:left;">通过 defineProps 传入的 props</td></tr> <tr><td style="text-align:left;">defaultValues</td> <td style="text-align:left;">object</td> <td style="text-align:left;">根据 props 的 key 传入默认值</td></tr></tbody></table> <p>可能缺乏一些官方描述，还是看参考用法可能更直观：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token punctuation">{</span>
  size<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
  labels<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  size<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token function-variable function">labels</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string">'default label'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果你要在 TS / JS 再对 props 进行获取，也可以通过字面量来拿到这些默认值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 如果不习惯上面的写法，你也可以跟平时一样先通过interface定义一个类型接口</span>
<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>
  msg<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// 再作为入参传入</span>
<span class="token keyword">const</span> props <span class="token operator">=</span> <span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">defineProps</span><span class="token generic class-name"><span class="token operator">&lt;</span>Props<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  msg<span class="token operator">:</span> <span class="token string">'hello'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 这样就可以通过props变量拿到需要的prop值了</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
</code></pre></div><h3 id="emits-的接收方式变化"><a href="#emits-的接收方式变化" class="header-anchor">#</a> emits 的接收方式变化</h3> <p>和 props 一样，emits 的接收也是需要使用一个全新的 API 来操作，这个 API 就是 <code>defineEmits</code> 。</p> <p>和 <code>defineProps</code> 一样， <code>defineEmits</code> 也是一个方法，它接受的入参格式和标准组件的要求是一致的。</p> <h4 id="defineemits-的基础用法"><a href="#defineemits-的基础用法" class="header-anchor">#</a> defineEmits 的基础用法</h4> <p>由于 emit 并非提供给模板直接读取，所以需要通过字面量来定义 emits。</p> <p>最基础的用法也是传递一个 <code>string[]</code> 数组进来，把每个 emit 的名称作为数组的 item 。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 获取 emit</span>
<span class="token keyword">const</span> emit <span class="token operator">=</span> <span class="token function">defineEmits</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'chang-name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 调用 emit</span>
<span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'chang-name'</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="attrs-的接收方式变化"><a href="#attrs-的接收方式变化" class="header-anchor">#</a> attrs 的接收方式变化</h3> <p><code>attrs</code> 和 <code>props</code> 很相似，也是基于父子通信的数据，如果父组件绑定下来的数据没有被指定为 <code>props</code> ，那么就会被挂到 <code>attrs</code> 这边来。</p> <p>在标准组件里， <code>attrs</code> 的数据是通过 <code>setup</code> 的第二个入参 <code>context</code> 里的 <code>attrs</code> API 获取的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 标准组件的写法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// attrs 是个对象，每个 Attribute 都是它的 key</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传下来的 Attribute 带有短横线，需要通过这种方式获取</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>attrs<span class="token punctuation">[</span><span class="token string">'data-hash'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>但和 <code>props</code> 一样，由于没有了 <code>context</code> 参数，需要使用一个新的 API 来拿到 <code>attrs</code> 数据。</p> <p>这个 API 就是 <code>useAttrs</code> 。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>请注意，<code>useAttrs</code> API 需要 Vue <code>3.1.4</code> 或更高版本才可以使用。</p></div> <h4 id="useattrs-的基础用法"><a href="#useattrs-的基础用法" class="header-anchor">#</a> useAttrs 的基础用法</h4> <p>顾名思义， useAttrs 可以是用来获取 attrs 数据的，它的用法非常简单：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 导入 useAttrs 组件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useAttrs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 获取 attrs</span>
<span class="token keyword">const</span> attrs <span class="token operator">=</span> <span class="token function">useAttrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// attrs是个对象，和 props 一样，需要通过 key 来得到对应的单个 attr</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="slots-的接收方式变化"><a href="#slots-的接收方式变化" class="header-anchor">#</a> slots 的接收方式变化</h3> <p><code>slots</code> 是 Vue 组件的插槽数据，也是在父子通信里的一个重要成员。</p> <p>对于使用 template 的开发者来说，在 script-setup 里获取插槽数据并不困难，因为跟标准组件的写法是完全一样的，可以直接在 template 里使用 <code>&lt;slot /&gt;</code> 标签渲染。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 插槽数据 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>slot</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 插槽数据 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>但对使用 JSX / TSX 的开发者来说，就影响比较大了，在标准组件里，想在 script 里获取插槽数据，也是需要在 <code>setup</code> 的第二个入参里拿到 <code>slots</code> API 。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 标准组件的写法</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 这里的 slots 就是插槽</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>新版本的 Vue 也提供了一个全新的 <code>useSlots</code> API 来帮助 script-setup 用户获取插槽。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>请注意，<code>useSlots</code> API 需要 Vue <code>3.1.4</code> 或更高版本才可以使用。</p></div> <h4 id="useslots-的基础用法"><a href="#useslots-的基础用法" class="header-anchor">#</a> useSlots 的基础用法</h4> <p>先来看看父组件，父组件先为子组件传入插槽数据 ：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子组件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ChildTSX</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 默认插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>I am a default slot from TSX.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 默认插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 命名插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name">#msg</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>I am a msg slot from TSX.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 命名插槽 --&gt;</span>

    <span class="token comment">&lt;!-- 作用域插槽 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span> <span class="token attr-name"><span class="token namespace">v-slot:</span>content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>slotprops<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{slotprops}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 作用域插槽 --&gt;</span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ChildTSX</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 子组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> ChildTSX <span class="token keyword">from</span> <span class="token string">'@cp/context/Child.tsx'</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在使用 JSX / TSX 编写的子组件里，就可以通过 <code>useSlots</code> 来获取父组件传进来的 <code>slots</code> 数据进行渲染：</p> <div class="language-tsx extra-class"><pre class="language-tsx"><code><span class="token comment">// 注意：这是一个 .tsx 文件</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> useSlots <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">const</span> ChildTSX <span class="token operator">=</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取插槽数据</span>
    <span class="token keyword">const</span> slots <span class="token operator">=</span> <span class="token function">useSlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 渲染组件</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token punctuation">{</span><span class="token comment">/* 渲染默认插槽 */</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> slots<span class="token punctuation">.</span>default <span class="token operator">?</span> slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

        </span><span class="token punctuation">{</span><span class="token comment">/* 渲染命名插槽 */</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> slots<span class="token punctuation">.</span>msg <span class="token operator">?</span> slots<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">

        </span><span class="token punctuation">{</span><span class="token comment">/* 渲染作用域插槽 */</span><span class="token punctuation">}</span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span> slots<span class="token punctuation">.</span>content <span class="token operator">?</span> slots<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">'作用域插槽'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ChildTSX
</code></pre></div><h3 id="ref-的通信方式变化"><a href="#ref-的通信方式变化" class="header-anchor">#</a> ref 的通信方式变化</h3> <p>在标准组件写法里，子组件的数据都是默认隐式暴露给父组件的，也就是父组件可以通过 <code>childComponent.value.foo</code> 这样的方式直接操作子组件的数据</p> <p>但在 script-setup 模式下，所有数据只是默认隐式 return 给 template 使用，不会暴露到组件外，所以父组件是无法直接通过挂载 ref 变量获取子组件的数据。</p> <p>在 script-setup 模式下，如果要调用子组件的数据，需要先在子组件显式的暴露出来，才能够正确的拿到，这个操作，就是由 <code>defineExpose</code> 来完成。</p> <h4 id="defineexpose-的基础用法"><a href="#defineexpose-的基础用法" class="header-anchor">#</a> defineExpose 的基础用法</h4> <p><code>defineExpose</code> 的用法非常简单，它本身是一个函数，可以接受一个对象参数。</p> <p>在子组件里，像这样把需要暴露出去的数据通过 <code>key: value</code> 的形式作为入参</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token comment">// 定义一个想提供给父组件拿到的数据</span>
<span class="token keyword">const</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> string <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>

<span class="token comment">// 显示暴露的数据，才可以在父组件拿到</span>
<span class="token function">defineExpose</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  msg
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后你在父组件就可以通过挂载在子组件上的 ref 变量，去拿到暴露出来的数据了。</p> <h2 id="组件的生命周期"><a href="#组件的生命周期" class="header-anchor">#</a> 组件的生命周期</h2> <p>从 Vue 2.x 升级到 3.x，在保留对 2.x 的生命周期支持的同时，3.x 也带来了一定的调整。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Vue 2 的生命周期写法名称是 Options API ， Vue 3 新的生命周期写法名称是 Composition API 。</p> <p>Vue 3 本身也支持 Options API 风格， Vue 2 也可以通过安装 <a href="https://www.npmjs.com/package/@vue/composition-api" target="_blank" rel="noopener noreferrer">@vue/composition-api<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件来使用 Composition API 。</p></div> <p>生命周期的变化，可以直观的从下表了解：</p> <table><thead><tr><th style="text-align:center;">2.x 生命周期</th> <th style="text-align:center;">3.x 生命周期</th> <th style="text-align:center;">执行时间说明</th></tr></thead> <tbody><tr><td style="text-align:center;">beforeCreate</td> <td style="text-align:center;">setup</td> <td style="text-align:center;">组件创建前执行</td></tr> <tr><td style="text-align:center;">created</td> <td style="text-align:center;">setup</td> <td style="text-align:center;">组件创建后执行</td></tr> <tr><td style="text-align:center;">beforeMount</td> <td style="text-align:center;">onBeforeMount</td> <td style="text-align:center;">组件挂载到节点上之前执行</td></tr> <tr><td style="text-align:center;">mounted</td> <td style="text-align:center;">onMounted</td> <td style="text-align:center;">组件挂载完成后执行</td></tr> <tr><td style="text-align:center;">beforeUpdate</td> <td style="text-align:center;">onBeforeUpdate</td> <td style="text-align:center;">组件更新之前执行</td></tr> <tr><td style="text-align:center;">updated</td> <td style="text-align:center;">onUpdated</td> <td style="text-align:center;">组件更新完成之后执行</td></tr> <tr><td style="text-align:center;">beforeDestroy</td> <td style="text-align:center;">onBeforeUnmount</td> <td style="text-align:center;">组件卸载之前执行</td></tr> <tr><td style="text-align:center;">destroyed</td> <td style="text-align:center;">onUnmounted</td> <td style="text-align:center;">组件卸载完成后执行</td></tr> <tr><td style="text-align:center;">errorCaptured</td> <td style="text-align:center;">onErrorCaptured</td> <td style="text-align:center;">当捕获一个来自子孙组件的异常时激活钩子函数</td></tr></tbody></table> <p>其中，在 3.x ，<code>setup</code> 的执行时机比 2.x 的 <code>beforeCreate</code> 和 <code>created</code> 还早，可以完全代替原来的这 2 个钩子函数。</p> <p>另外，被包含在 <code>&lt;keep-alive&gt;</code> 中的组件，会多出两个生命周期钩子函数：</p> <table><thead><tr><th style="text-align:center;">2.x 生命周期</th> <th style="text-align:center;">3.x 生命周期</th> <th style="text-align:center;">执行时间说明</th></tr></thead> <tbody><tr><td style="text-align:center;">activated</td> <td style="text-align:center;">onActivated</td> <td style="text-align:center;">被激活时执行</td></tr> <tr><td style="text-align:center;">deactivated</td> <td style="text-align:center;">onDeactivated</td> <td style="text-align:center;">切换组件后，原组件消失前执行</td></tr></tbody></table> <h2 id="vue3-0-中的响应式原理"><a href="#vue3-0-中的响应式原理" class="header-anchor">#</a> Vue3.0 中的响应式原理</h2> <h3 id="vue2-x-的响应式"><a href="#vue2-x-的响应式" class="header-anchor">#</a> vue2.x 的响应式</h3> <ul><li><p>实现原理：</p> <ul><li><p>对象类型：通过<code>Object.defineProperty()</code>对属性的读取、修改进行拦截（数据劫持）。</p></li> <li><p>数组类型：通过重写更新数组的一系列方法来实现拦截。（对数组的变更方法进行了包裹）。</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></li></ul></li> <li><p>存在问题：</p> <ul><li>新增属性、删除属性, 界面不会更新。</li> <li>直接通过下标修改数组, 界面不会自动更新。</li></ul></li></ul> <h3 id="vue3-0-的响应式"><a href="#vue3-0-的响应式" class="header-anchor">#</a> Vue3.0 的响应式</h3> <ul><li><p>实现原理:</p> <ul><li><p>通过 Proxy（代理）: 拦截对象中任意属性的变化, 包括：属性值的读写、属性的添加、属性的删除等。</p></li> <li><p>通过 Reflect（反射）: 对源对象的属性进行操作。</p></li> <li><p>MDN 文档中描述的 Proxy 与 Reflect：</p> <ul><li><p>Proxy：https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy</p></li> <li><p>Reflect：https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 拦截读取属性值</span>
  <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 拦截设置属性值或添加新属性</span>
  <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 拦截删除属性</span>
  <span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> prop</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prop<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

proxy<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'tom'</span>
</code></pre></div></li></ul></li></ul></li></ul> <h2 id="响应式-api-之-ref"><a href="#响应式-api-之-ref" class="header-anchor">#</a> 响应式 API 之 ref</h2> <p><code>ref</code> 是最常用的一个响应式 API，它可以用来定义所有类型的数据，包括 Node 节点。</p> <p>没错，在 2.x 常用的 <code>this.$refs.xxx</code> 来取代 <code>document.querySelector('.xxx')</code> 获取 Node 节点的方式，也是用这个 API 来取代。</p> <h3 id="类型声明"><a href="#类型声明" class="header-anchor">#</a> 类型声明</h3> <p>在开始使用 API 之前，要先了解一下在 TypeScript 中，<code>ref</code> 需要如何进行类型声明。</p> <p>平时我们在定义变量的时候，都是这样给他们进行类型声明的：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 单类型</span>
<span class="token keyword">const</span> msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>

<span class="token comment">// 多类型</span>
<span class="token keyword">const</span> phoneNumber<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token number">13800138000</span><span class="token punctuation">;</span>
</code></pre></div><p>但是在使用 <code>ref</code> 时，不能这样子声明，会报错，正确的声明方式应该是使用 <code>&lt;&gt;</code> 来包裹类型定义，紧跟在 <code>ref</code> API 之后：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 单类型</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 多类型</span>
<span class="token keyword">const</span> phoneNumber <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">13800138000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="变量的定义"><a href="#变量的定义" class="header-anchor">#</a> 变量的定义</h3> <p>了解了如何进行类型声明之后，对变量的定义就没什么问题了，前面说了它可以用来定义所有类型的数据，包括 Node 节点，但不同类型的值之间还是有少许差异和注意事项，具体可以参考如下。</p> <h4 id="基本类型"><a href="#基本类型" class="header-anchor">#</a> 基本类型</h4> <p>对字符串、布尔值等基本类型的定义方式，比较简单：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 字符串</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 数值</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 布尔值</span>
<span class="token keyword">const</span> isVip <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="引用类型"><a href="#引用类型" class="header-anchor">#</a> 引用类型</h4> <p>对于对象、数组等引用类型也适用，比如要定义一个对象：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>Member<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'Tom'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>定义一个普通数组：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 数字数组</span>
<span class="token keyword">const</span> uids <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 字符串数组</span>
<span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token string">'Tom'</span><span class="token punctuation">,</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span> <span class="token string">'Andy'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>定义一个对象数组：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员组</span>
<span class="token keyword">const</span> memberList <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>Member<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Tom'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Petter'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="dom-元素与子组件"><a href="#dom-元素与子组件" class="header-anchor">#</a> DOM 元素与子组件</h3> <p>除了可以定义数据，<code>ref</code> 也有我们熟悉的用途，就是用来挂载节点，也可以挂在子组件上。</p> <p>对于 2.x 常用的 <code>this.$refs.xxx</code> 来获取 DOM 元素信息，该 API 的使用方式也是同样：</p> <p>模板部分依然是熟悉的用法，把 ref 挂到你要引用的 DOM 上。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载DOM元素 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    留意该节点，有一个ref属性
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载DOM元素 --&gt;</span>

  <span class="token comment">&lt;!-- 挂载子组件 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token comment">&lt;!-- 挂载子组件 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><code>script</code> 部分有三个最基本的注意事项：</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>定义挂载节点后，也是必须通过 <code>xxx.value</code> 才能正确操作到挂载的 DOM 元素或组件（详见下方的<a href="#%E5%8F%98%E9%87%8F%E7%9A%84%E8%AF%BB%E5%8F%96%E4%B8%8E%E8%B5%8B%E5%80%BC">变量的读取与赋值</a>）；</p></li> <li><p>请保证视图渲染完毕后再执行 DOM 或组件的相关操作（需要放到生命周期的 <code>onMounted</code> 或者 <code>nextTick</code> 函数里，这一点在 2.x 也是一样）；</p></li> <li><p>该变量必须 <code>return</code> 出去才可以给到 <code>template</code> 使用（这一点是 3.x 生命周期的硬性要求，子组件的数据和方法如果要给父组件操作，也要 <code>return</code> 出来才可以）。</p></li></ol></div> <p>配合上面的 <code>template</code> ，来看看 <code>script</code> 部分的具体例子：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'@cp/Child.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义挂载节点，声明的类型详见下方附表</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLElement <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">typeof</span> Child <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 请保证视图渲染完毕后再执行节点操作 e.g. onMounted / nextTick</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 比如获取DOM的文本</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value<span class="token punctuation">.</span>innerText<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 或者操作子组件里的数据</span>
      child<span class="token punctuation">.</span>value<span class="token punctuation">.</span>isShowDialog <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 必须return出去才可以给到template使用</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      child
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>关于 DOM 和子组件的 TS 类型声明，可参考以下规则：</p> <table><thead><tr><th style="text-align:left;">节点类型</th> <th style="text-align:left;">声明类型</th> <th style="text-align:left;">参考文档</th></tr></thead> <tbody><tr><td style="text-align:left;">DOM 元素</td> <td style="text-align:left;">使用 HTML 元素接口</td> <td style="text-align:left;"><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document_Object_Model#html_%E5%85%83%E7%B4%A0%E6%8E%A5%E5%8F%A3" target="_blank" rel="noopener noreferrer">HTML 元素接口<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr> <tr><td style="text-align:left;">子组件</td> <td style="text-align:left;">使用 typeof 获取子组件的类型</td> <td style="text-align:left;"><a href="https://zhuanlan.zhihu.com/p/311150643" target="_blank" rel="noopener noreferrer">typeof 操作符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td></tr></tbody></table> <h3 id="变量的读取与赋值"><a href="#变量的读取与赋值" class="header-anchor">#</a> 变量的读取与赋值</h3> <p>被 <code>ref</code> 包裹的变量会全部变成对象，不管你定义的是什么类型的值，都会转化为一个 ref 对象，其中 ref 对象具有指向内部值的单个 property <code>.value</code>。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>读取任何 ref 对象的值都必须通过 <code>xxx.value</code> 才可以正确获取到。</p></div> <p>普通变量都必须使用 <code>let</code> 才可以修改值，由于 ref 对象是个引用类型，所以可以在 <code>const</code> 定义的时候，直接通过 <code>.value</code> 来修改。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 定义一个字符串变量</span>
<span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1s后修改它的值</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  msg<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello!'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因此你在对接接口数据的时候，可以自由的使用 <code>forEach</code>、<code>map</code>、<code>filter</code> 等遍历函数来操作你的 ref 数组，或者直接重置它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提取接口的数据</span>
data<span class="token punctuation">.</span>value <span class="token operator">=</span> api<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>item<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>text <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 重置数组</span>
data<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="响应式-api-之-reactive"><a href="#响应式-api-之-reactive" class="header-anchor">#</a> 响应式 API 之 reactive</h2> <p><code>reactive</code> 是继 <code>ref</code> 之后最常用的一个响应式 API 了，相对于 <code>ref</code>，它的局限性在于只适合对象、数组。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用 <code>reactive</code> 的好处就是写法跟平时的对象、数组几乎一模一样，但它也带来了一些特殊注意点，请留意赋值部分的特殊说明。</p></div> <h3 id="类型声明与定义"><a href="#类型声明与定义" class="header-anchor">#</a> 类型声明与定义</h3> <p><code>reactive</code> 的声明方式，以及定义方式，没有 <code>ref</code> 的变化那么大，就是和普通变量一样。</p> <p>reactive 对象：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'Tom'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>reactive 数组：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 普通数组</span>
<span class="token keyword">const</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 对象数组</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象数组</span>
<span class="token keyword">const</span> userList<span class="token operator">:</span> Member<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Tom'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Petter'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Andy'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="变量的读取与赋值-2"><a href="#变量的读取与赋值-2" class="header-anchor">#</a> 变量的读取与赋值</h3> <p>reactive 对象在读取字段的值，或者修改值的时候，与普通对象是一样的。</p> <p>reactive 对象：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 声明对象的格式</span>
<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个成员对象</span>
<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'Tom'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取用户名</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改用户名</span>
userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Petter'</span><span class="token punctuation">;</span>
</code></pre></div><p>但是对于 reactive 数组，和普通数组会有一些区别。</p> <p>先看看普通数组，重置，或者改变值，都是可以直接轻松的进行操作：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 定义一个普通数组</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 从另外一个对象数组里提取数据过来</span>
uids <span class="token operator">=</span> api<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span> item <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span>id <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 合并另外一个数组</span>
<span class="token keyword">let</span> newUids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>uids<span class="token punctuation">,</span> <span class="token operator">...</span>newUids<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 重置数组</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>在 2.x 的时候，你在操作数组时，完全可以和普通数组那样随意的处理数据的变化，依然能够保持响应性。</p> <p>但在 3.x ，如果你使用 <code>reactive</code> 定义数组，则不能这么搞了，必须只使用那些不会改变引用地址的操作。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>按照原来的思维去使用 <code>reactive</code> 数组，会造成数据变了，但模板不会更新的 bug ，如果你遇到类似的情况，可以从这里去入手排查问题所在。</p></div> <p>举个例子，比如你要从接口读取翻页数据的时候，通常要先重置数组，再异步添加数据：</p> <p>如果你使用常规的重置，会导致这个变量失去响应性：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/** 
 * 不推荐使用这种方式
 * 异步添加数据后，模板不会响应更新
 */</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 丢失响应性的步骤</span>
uids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 异步获取数据后，模板依然是空数组</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uids<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>要让模板那边依然能够保持响应性，则必须在关键操作时，不破坏响应性 API 的存在。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/** 
 * 不推荐使用这种方式
 * 异步添加数据后，模板不会响应更新
 */</span>
<span class="token keyword">let</span> uids<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">[</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 不会破坏响应性</span>
uids<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">// 异步获取数据后，模板可以正确的展示</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  uids<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="特别注意"><a href="#特别注意" class="header-anchor">#</a> 特别注意</h3> <p>不要对通过 <code>reactive</code> 定义的对象进行解构，解构后得到的变量会失去响应性。</p> <p>比如这些情况，在 2s 后都得不到新的 name 信息：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 定义一个带有响应性的成员对象</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s后更新userInfo</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个变量在2s后不会同步更新</span>
    <span class="token keyword">const</span> newUserInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>userInfo<span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 这个变量在2s后不会再同步更新</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name <span class="token punctuation">}</span> <span class="token operator">=</span> userInfo<span class="token punctuation">;</span>

    <span class="token comment">// 这样return出去给模板用，在2s后也不会同步更新</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>userInfo
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="响应式-api-之-toref-与-torefs"><a href="#响应式-api-之-toref-与-torefs" class="header-anchor">#</a> 响应式 API 之 toRef 与 toRefs</h2> <p>看到这里之前，应该对 <code>ref</code> 和 <code>reactive</code> 都有所了解了，为了方便开发者，Vue 3 还推出了 2 个与之相关的 API ，用于 <code>reactive</code> 向 <code>ref</code> 转换。</p> <h3 id="各自的作用"><a href="#各自的作用" class="header-anchor">#</a> 各自的作用</h3> <p>两个 API 的拼写非常接近，顾名思义，一个是只转换一个字段，一个是转换所有字段。</p> <table><thead><tr><th style="text-align:left;">API</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">toRef</td> <td style="text-align:left;">创建一个新的ref变量，转换 reactive 对象的某个字段为ref变量</td></tr> <tr><td style="text-align:left;">toRefs</td> <td style="text-align:left;">创建一个新的对象，它的每个字段都是 reactive 对象各个字段的ref变量</td></tr></tbody></table> <p>我们先定义好一个 <code>reactive</code> 变量：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'Petter'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后来看看这 2 个 API 应该怎么使用。</p> <h3 id="使用-toref"><a href="#使用-toref" class="header-anchor">#</a> 使用 toRef</h3> <p><code>toRef</code> 接收 2 个参数，第一个是 <code>reactive</code> 对象, 第二个是要转换的 <code>key</code> 。</p> <p>在这里我们只想转换 <code>userInfo</code> 里的 <code>name</code> ，只需要这样操作：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">toRef</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样就成功创建了一个 <code>ref</code> 变量。</p> <p>之后读取和赋值就使用 <code>name.value</code>，它会同时更新 <code>name</code> 和 <code>userInfo.name</code>。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在 <code>toRef</code> 的过程中，如果使用了原对象上面不存在的 <code>key</code> ，那么定义出来的变量的 <code>value</code> 将会是 <code>undefined</code> 。</p> <p>如果你对这个不存在的 <code>key</code> 的 <code>ref</code> 变量，进行了 <code>value</code> 赋值，那么原来的对象也会同步增加这个 <code>key</code>，其值也会同步更新。</p></div> <h3 id="使用-torefs"><a href="#使用-torefs" class="header-anchor">#</a> 使用 toRefs</h3> <p><code>toRefs</code> 接收 1 个参数，是一个 <code>reactive</code> 对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> userInfoRefs<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个新的 <code>userInfoRefs</code> ，本身是个普通对象，但是它的每个字段，都是与原来关联的 <code>ref</code> 变量。</p> <h3 id="为什么要进行转换"><a href="#为什么要进行转换" class="header-anchor">#</a> 为什么要进行转换</h3> <p>关于为什么要出这么 2 个 API ，官方文档没有特别说明，不过经过自己的一些实际使用，以及在写上一节 <code>reactive</code> 的 <a href="#%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8F">特别注意</a>，可能知道一些使用理由。</p> <p><code>ref</code> 和 <code>reactive</code> 这两者的好处就不重复了，但是在使用的过程中，各自都有各自不方便的地方：</p> <ol><li><p><code>ref</code> 虽然在 <code>template</code> 里使用起来方便，但比较烦的一点是在 <code>script</code> 里进行读取/赋值的时候，要一直记得加上 <code>.value</code> ，否则bug就来了</p></li> <li><p><code>reactive</code> 虽然在使用的时候，因为你知道它本身是一个 <code>Object</code> 类型，所以你不会忘记 <code>foo.bar</code> 这样的格式去操作，但是在 <code>template</code> 渲染的时候，你又因此不得不每次都使用 <code>foo.bar</code> 的格式去渲染</p></li></ol> <p>那么有没有办法，既可以在编写 <code>script</code> 的时候不容易出错，在写 <code>template</code> 的时候又比较简单呢？</p> <p>于是， <code>toRef</code> 和 <code>toRefs</code> 因此诞生。</p> <h3 id="什么场景下比较适合使用它们"><a href="#什么场景下比较适合使用它们" class="header-anchor">#</a> 什么场景下比较适合使用它们</h3> <p>从便利性和可维护性来说，最好只在功能单一、代码量少的组件里使用，比如一个表单组件，通常表单的数据都放在一个对象里。</p> <p>当然你也可以更猛一点就是把所有的数据都定义到一个 <code>data</code> 里，然后你再去 <code>data</code> 里面取…但是没有必要为了转换而转换。</p> <h3 id="在业务中的具体运用"><a href="#在业务中的具体运用" class="header-anchor">#</a> 在业务中的具体运用</h3> <p><strong>在 <code>script</code> 部分：</strong></p> <ol><li><p>先用 <code>reactive</code> 定义一个源数据，所有的数据更新，都是修改这个对象对应的值，按照对象的写法去维护你的数据</p></li> <li><p>再通过 <code>toRefs</code> 定义一个给 <code>template</code> 用的对象，它本身不具备响应性，但是它的字段全部是 <code>ref</code> 变量</p></li> <li><p>在 <code>return</code> 的时候，对 <code>toRefs</code> 对象进行解构，这样导出去就是各个字段对应的 <code>ref</code> 变量，而不是一整个对象</p></li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> toRefs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  gender<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个reactive对象</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
      gender<span class="token operator">:</span> <span class="token string">'male'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 定义一个新的对象，它本身不具备响应性，但是它的字段全部是ref变量</span>
    <span class="token keyword">const</span> userInfoRefs <span class="token operator">=</span> <span class="token function">toRefs</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s后更新userInfo</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
      userInfo<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在这里结构toRefs对象才能继续保持响应式</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>userInfoRefs
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>在 <code>template</code> 部分：</strong></p> <p>由于 <code>return</code> 出来的都是 <code>ref</code> 变量，所以你在模板里直接使用 <code>userInfo</code> 各个字段的 <code>key</code> 即可。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>user-info<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>ID:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ id }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>name:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>age:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ age }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>key<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>gender:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ gender }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="需要注意的问题"><a href="#需要注意的问题" class="header-anchor">#</a> 需要注意的问题</h3> <p>请注意是否有相同命名的变量存在，比如上面在 <code>return</code> 给 <code>template</code> 使用时，解构 <code>userInfoRefs</code> 的时候已经包含了一个 <code>name</code> 字段，此时如果还有一个单独的变量也叫 <code>name</code>。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>那么他们谁会生效，取决于谁排在后面。</p> <p>因为 <code>return</code> 出去的其实是一个对象，在对象里，如果存在相同的 <code>key</code> ，则后面那个会覆盖前面的。</p></div> <p>这种情况下，会以单独定义的 <code>name</code> 为渲染数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>userInfoRefs<span class="token punctuation">,</span>
  name
<span class="token punctuation">}</span>
</code></pre></div><p>这种情况下，则是以 <code>userInfoRefs</code> 里的 <code>name</code> 为渲染数据。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">return</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">,</span>
  <span class="token operator">...</span>userInfoRefs
<span class="token punctuation">}</span>
</code></pre></div><p>所以当你决定使用 <code>toRef</code> 和 <code>toRefs</code> 的时候，请注意这个特殊情况！</p> <h2 id="其它响应式api"><a href="#其它响应式api" class="header-anchor">#</a> 其它响应式API</h2> <h3 id="readonly"><a href="#readonly" class="header-anchor">#</a> readonly()</h3> <p>接受一个对象 (不论是响应式还是一般的) 或是一个 ref，返回一个原值的只读代理。
只读代理是深层的：对任何嵌套 property 的访问都将是只读的。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> original <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> copy <span class="token operator">=</span> <span class="token keyword">readonly</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>

<span class="token function">watchEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用来做响应性追踪</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>copy<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 更改源属性会触发其依赖的侦听器</span>
original<span class="token punctuation">.</span>count<span class="token operator">++</span>

<span class="token comment">// 更改该只读副本将会失败，并会得到一个警告</span>
copy<span class="token punctuation">.</span>count<span class="token operator">++</span> <span class="token comment">// warning!</span>
</code></pre></div><h3 id="isref"><a href="#isref" class="header-anchor">#</a> isRef()</h3> <p>检查某个值是否为 ref。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> foo<span class="token operator">:</span> <span class="token builtin">unknown</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRef</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  foo<span class="token punctuation">.</span>value
<span class="token punctuation">}</span>
</code></pre></div><h3 id="unref"><a href="#unref" class="header-anchor">#</a> unref()</h3> <p>如果参数是 ref，则返回内部值，否则返回参数本身。这是 val = isRef(val) ? val.value : val 计算的一个语法糖。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> foo<span class="token operator">=</span><span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> copyFoo<span class="token operator">=</span><span class="token function">unref</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span>copyFoo<span class="token punctuation">)</span>
</code></pre></div><h3 id="isproxy"><a href="#isproxy" class="header-anchor">#</a> isProxy()</h3> <p>检查一个对象是否是由 reactive()、readonly()、shallowReactive() 或 shallowReadonly() 创建的代理。</p> <h3 id="isreactive"><a href="#isreactive" class="header-anchor">#</a> isReactive()</h3> <p>检查一个对象是否是由 reactive() 或 shallowReactive() 创建的代理。</p> <h3 id="isreactive-2"><a href="#isreactive-2" class="header-anchor">#</a> isReactive()</h3> <p>检查一个对象是否是由 readonly() 或 shallowReadonly() 创建的代理。</p> <h3 id="shallowref"><a href="#shallowref" class="header-anchor">#</a> shallowRef()</h3> <p>ref() 的浅层作用形式。
和 ref() 不同，浅层 ref 的内部值将会原样存储和暴露，并且不会被深层递归地转为响应式。只有对 .value 的访问是响应式的。</p> <h3 id="triggerref"><a href="#triggerref" class="header-anchor">#</a> triggerRef()</h3> <p>强制触发依赖于一个浅层 ref 的副作用，这通常在对浅引用的内部值进行深度变更后使用。</p> <h3 id="shallowreactive"><a href="#shallowreactive" class="header-anchor">#</a> shallowReactive()</h3> <p>reactive() 的浅层作用形式。
和 reactive() 不同，这里没有深层级的转换：一个浅层响应式对象里只有根级别的 property 是响应式的。</p> <h3 id="shallowreadonly"><a href="#shallowreadonly" class="header-anchor">#</a> shallowReadonly()</h3> <p>readonly() 的浅层作用形式</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">shallowReadonly</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  foo<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  nested<span class="token operator">:</span> <span class="token punctuation">{</span>
    bar<span class="token operator">:</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 更改状态自身的属性会失败</span>
state<span class="token punctuation">.</span>foo<span class="token operator">++</span>

<span class="token comment">// ...但可以更改下层嵌套对象</span>
<span class="token function">isReadonly</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>nested<span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token comment">// 这是可以通过的</span>
state<span class="token punctuation">.</span>nested<span class="token punctuation">.</span>bar<span class="token operator">++</span>

</code></pre></div><h3 id="toraw"><a href="#toraw" class="header-anchor">#</a> toRaw()</h3> <p>根据一个 Vue 创建的代理返回其原始对象。
toRaw() 可以返回由 reactive()、readonly()、shallowReactive() 或者 shallowReadonly() 创建的代理对应的原始对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> reactiveFoo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">toRaw</span><span class="token punctuation">(</span>reactiveFoo<span class="token punctuation">)</span> <span class="token operator">===</span> foo<span class="token punctuation">)</span> <span class="token comment">// true</span>

</code></pre></div><h3 id="markraw"><a href="#markraw" class="header-anchor">#</a> markRaw()</h3> <p>将一个对象标记为不可被转为代理。返回该对象本身。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">markRaw</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span><span class="token function">reactive</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

<span class="token comment">// 也适用于嵌套在其他响应性对象</span>
<span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span> foo <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>bar<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>

</code></pre></div><h3 id="customref"><a href="#customref" class="header-anchor">#</a> customRef()</h3> <p>创建一个自定义的 ref，显式声明对其依赖追踪和更新触发的控制方式。
customRef() 预期接收一个函数作为参数，这个函数接受 track 和 trigger 两个函数作为参数，并返回一个带有 get 和 set 方法的对象。</p> <p>创建一个防抖 ref，即只在最近一次 set 调用后的一段固定间隔后再调用：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> customRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">function</span> <span class="token function">useDebouncedRef</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">value</span><span class="token operator">:</span>string<span class="token punctuation">,</span> delay <span class="token operator">=</span> <span class="token number">200</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token literal-property property">timeout</span><span class="token operator">:</span>any
  <span class="token keyword">return</span> <span class="token function">customRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">track<span class="token punctuation">,</span> trigger</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          value <span class="token operator">=</span> newValue
          <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">useDebouncedRef</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><h2 id="自定义-hook-函数"><a href="#自定义-hook-函数" class="header-anchor">#</a> 自定义 hook 函数</h2> <ul><li><p>什么是 hook？—— 本质是一个函数，把 setup 函数中使用的 Composition API 进行了封装。</p></li> <li><p>类似于 vue2.x 中的 mixin。</p></li> <li><p>自定义 hook 的优势: 复用代码, 让 setup 中的逻辑更清楚易懂。</p></li></ul> <h2 id="数据的监听"><a href="#数据的监听" class="header-anchor">#</a> 数据的监听</h2> <p>Vue 3 在保留原来的 <code>watch</code> 功能之外，还新增了一个 <code>watchEffect</code> 帮助我们更简单的进行监听。</p> <h3 id="watch"><a href="#watch" class="header-anchor">#</a> watch</h3> <p>在 Vue 3 ，新版的 <code>watch</code> 和 Vue 2 的旧版写法对比，在使用方式上变化非常大！</p> <h4 id="回顾-vue-2"><a href="#回顾-vue-2" class="header-anchor">#</a> 回顾 Vue 2</h4> <p>在 Vue 2 是这样用的，和 <code>data</code> 、 <code>methods</code> 都在同级配置：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 注意这里，放在 data 、 methods 同个级别</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>并且类型繁多，选项式 API 的类型如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code>watch<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">Function</span> <span class="token operator">|</span> Object <span class="token operator">|</span> <span class="token builtin">Array</span><span class="token punctuation">}</span>
</code></pre></div><p>联合类型过多，意味着用法复杂，下面是个很好的例子，虽然出自 <a href="https://v3.cn.vuejs.org/api/options-data.html#watch" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的用法介绍，但也反映出来对初学者不太友好，初次接触可能会觉得一头雾水：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      b<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      c<span class="token operator">:</span> <span class="token punctuation">{</span>
        d<span class="token operator">:</span> <span class="token number">4</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      e<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      f<span class="token operator">:</span> <span class="token number">6</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  watch<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 侦听顶级 property</span>
    <span class="token function">a</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">new: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>val<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, old: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 字符串方法名</span>
    b<span class="token operator">:</span> <span class="token string">'someMethod'</span><span class="token punctuation">,</span>
    <span class="token comment">// 该回调会在任何被侦听的对象的 property 改变时被调用，不论其被嵌套多深</span>
    c<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c changed'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      deep<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 侦听单个嵌套 property</span>
    <span class="token string-property property">'c.d'</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// do something</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 该回调将会在侦听开始之后被立即调用</span>
    e<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e changed'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      immediate<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 你可以传入回调数组，它们会被逐一调用</span>
    f<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'handle1'</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span> <span class="token function">handle2</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'handle2 triggered'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">handle3</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'handle3 triggered'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* ... */</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b changed'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handle1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'handle 1 triggered'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然肯定也会有人觉得这样选择多是个好事，选择适合自己的就好，但我个人还是感觉，这种写法对于初学者来说不是那么友好，有些过于复杂化，如果一个用法可以适应各种各样的场景，岂不是更妙？</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>另外需要注意的是，不能使用箭头函数来定义 watcher 函数 (例如 <code>searchQuery: newValue =&gt; this.updateAutocomplete(newValue)</code> )。</p> <p>因为箭头函数绑定了父级作用域的上下文，所以 <code>this</code> 将不会按照期望指向组件实例， <code>this.updateAutocomplete</code> 将是 <code>undefined</code> 。</p></div> <p>Vue 2 也可以通过 <code>this.$watch()</code> 这个 API 的用法来实现对某个数据的监听，它接受三个参数： <code>source</code> 、 <code>callback</code> 和 <code>options</code> 。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 生命周期钩子</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$watch</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> oldVal<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于 <code>this.$watch</code> 的用法和 Vue 3 比较接近，所以这里不做过多的回顾，请直接看 <a href="#%E4%BA%86%E8%A7%A3-vue-3-1">了解 Vue 3</a> 部分。</p> <h4 id="了解-vue-3"><a href="#了解-vue-3" class="header-anchor">#</a> 了解 Vue 3</h4> <p>在 Vue 3 的组合式 API 写法， <code>watch</code> 是一个可以接受 3 个参数的函数（保留了 Vue 2 的 <code>this.$watch</code> 这种用法），在使用层面上简单了好多。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 一个用法走天下</span>
<span class="token function">watch</span><span class="token punctuation">(</span>
  source<span class="token punctuation">,</span> <span class="token comment">// 必传，要监听的数据源</span>
  callback<span class="token punctuation">,</span> <span class="token comment">// 必传，监听到变化后要执行的回调函数</span>
  <span class="token comment">// options // 可选，一些监听选项</span>
<span class="token punctuation">)</span>
</code></pre></div><p>下面的内容都基于 Vue 3 的组合式 API 用法展开讲解。</p> <p>API 接受 3 个入参：</p> <table><thead><tr><th style="text-align:center;">参数</th> <th style="text-align:center;">是否可选</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:center;">source</td> <td style="text-align:center;">必传</td> <td style="text-align:left;">数据源（详见：<a href="#%E8%A6%81%E7%9B%91%E5%90%AC%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90">要监听的数据源</a>）</td></tr> <tr><td style="text-align:center;">callback</td> <td style="text-align:center;">必传</td> <td style="text-align:left;">监听到变化后要执行的回调函数（详见：<a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a>）</td></tr> <tr><td style="text-align:center;">options</td> <td style="text-align:center;">可选</td> <td style="text-align:left;">一些监听选项（详见：<a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a>）</td></tr></tbody></table> <p>并返回一个可以用来停止监听的函数（详见：<a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a>）。</p> <h4 id="要监听的数据源"><a href="#要监听的数据源" class="header-anchor">#</a> 要监听的数据源</h4> <p>watch API 的第 1 个参数 <code>source</code> 是要监听的数据源，它的 TS 类型如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// watch 第 1 个入参的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchSource<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> Ref<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> ComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><p>可以看到能够用于监听的数据，是通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F%E6%95%B0%E6%8D%AE%E7%9A%84%E5%8F%98%E5%8C%96-new">响应式 API</a> 定义的变量（ <code>Ref&lt;T&gt;</code> ），或者是一个 <a href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E8%AE%A1%E7%AE%97-new">计算数据</a> （ <code>ComputedRef&lt;T&gt;</code> ），或者是一个 返回值的函数。</p> <p>所以要想定义的 watch 能够做出预期的行为，数据源必须具备响应性或者是一个 getter ，如果只是通过 <code>let</code> 定义一个普通变量，然后去改变这个变量的值，这样是无法监听的。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果要监听响应式对象里面的某个值（这种情况下对象本身是响应式，但它的 property 不是），需要写成有返回值的函数，这个函数 return 你要监听的数据， e.g. <code>() =&gt; foo.bar</code> ，可以结合下方 <a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a> 的例子一起理解。</p></div> <h4 id="监听后的回调函数"><a href="#监听后的回调函数" class="header-anchor">#</a> 监听后的回调函数</h4> <p>watch API 的第 2 个参数 <code>callback</code> 是监听到数据变化时要做出的行为，它的 TS 类型如下：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// watch 第 2 个入参的 TS 类型</span>
<span class="token comment">// ...</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">type</span> <span class="token class-name">WatchCallback<span class="token operator">&lt;</span><span class="token constant">V</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token constant">OV</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  value<span class="token operator">:</span> <span class="token constant">V</span><span class="token punctuation">,</span>
  oldValue<span class="token operator">:</span> <span class="token constant">OV</span><span class="token punctuation">,</span>
  onCleanup<span class="token operator">:</span> OnCleanup
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span>
<span class="token comment">// ...</span>
</code></pre></div><p>乍一看它有三个参数，但实际上这些参数不是你自己定义的，而是 watch API 传给你的，所以不管你用或者不用，它们都在那里：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">value</td> <td style="text-align:left;">变化后的新值，类型和数据源保持一致</td></tr> <tr><td style="text-align:left;">oldValue</td> <td style="text-align:left;">变化前的旧值，类型和数据源保持一致</td></tr> <tr><td style="text-align:left;">onCleanup</td> <td style="text-align:left;">注册一个清理函数，详见 <a href="#%E7%9B%91%E5%90%AC%E6%95%88%E6%9E%9C%E6%B8%85%E7%90%86">监听效果清理</a> 部分</td></tr></tbody></table> <p>注意：第一个参数是新值，第二个才是原来的旧值！</p> <p>如同其他 JS 函数，在使用 watch 的回调函数时，可以对这三个参数任意命名，比如把 <code>value</code> 命名为你觉得更容易理解的 <code>newValue</code> 。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>如果监听的数据源是一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures#%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreferrer">引用类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 时（ e.g. <code>Object</code> 、 <code>Array</code> 、 <code>Date</code> … ）， <code>value</code> 和 <code>oldValue</code> 是完全相同的，因为指向同一个对象。</p></div> <p>另外，默认情况下，<code>watch</code> 是惰性的，也就是只有当被监听的数据源发生变化时才执行回调。</p> <h4 id="基础用法"><a href="#基础用法" class="header-anchor">#</a> 基础用法</h4> <p>来到这里，对 2 个必传的参数都有一定的了解了，我们先看看基础的用法，也就是日常最常编写的方案，我们只需要先关注前 2 个必传的参数。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 不要忘了导入要用的 API</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个响应式数据</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Tom'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 可以直接监听这个响应式对象
     * callback 的参数如果不用可以不写
     */</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'监听整个 userInfo '</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">/**
     * 也可以监听对象里面的某个值
     * 此时数据源需要写成 getter 函数
     */</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>
      <span class="token comment">// 数据源，getter 形式</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      <span class="token comment">// 回调函数 callback</span>
      <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'只监听 name 的变化 '</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'打印变化前后的值'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> oldValue<span class="token punctuation">,</span> newValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>一般的业务场景，基础用法足以面对。</p> <p>如果你有多个数据源要监听，并且监听到变化后要执行的行为一样，那么可以使用 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> 。</p> <p>特殊的情况下，你可以搭配 <a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a> 做一些特殊的用法，详见下面部分的内容。</p> <h4 id="批量监听"><a href="#批量监听" class="header-anchor">#</a> 批量监听</h4> <p>如果你有多个数据源要监听，并且监听到变化后要执行的行为一样，第一反应可能是这样来写：</p> <ol><li>抽离相同的处理行为为公共函数</li> <li>然后定义多个监听操作，传入这个公共函数</li></ol> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 来到这里才会触发 watch 的回调</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
      index<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// 抽离相同的处理行为为公共函数</span>
    <span class="token keyword">const</span> handleWatch <span class="token operator">=</span> <span class="token punctuation">(</span>
      newValue<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
      oldValue<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span>
    <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> newValue<span class="token punctuation">,</span> oldValue <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 然后定义多个监听操作，传入这个公共函数</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> handleWatch<span class="token punctuation">)</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> handleWatch<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样写其实没什么问题，不过除了抽离公共代码的写法之外， watch API 还提供了一个批量监听的用法，和 <a href="#%E5%9F%BA%E7%A1%80%E7%94%A8%E6%B3%95">基础用法</a> 的区别在于，数据源和回调参数都变成了数组的形式。</p> <p>数据源：以数组的形式传入，里面每一项都是一个响应式数据。</p> <p>回调参数：原来的 <code>value</code> 和 <code>newValue</code> 也都变成了数组，每个数组里面的顺序和数据源数组排序一致。</p> <p>可以看下面的这个例子更为直观：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义多个数据源</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
      index<span class="token punctuation">.</span>value<span class="token operator">++</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>
      <span class="token comment">// 数据源改成了数组</span>
      <span class="token punctuation">[</span>message<span class="token punctuation">,</span> index<span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token comment">// 回调的入参也变成了数组，每个数组里面的顺序和数据源数组排序一致</span>
      <span class="token punctuation">(</span><span class="token punctuation">[</span>newMessage<span class="token punctuation">,</span> newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>oldMessage<span class="token punctuation">,</span> oldIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'message 的变化'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> newMessage<span class="token punctuation">,</span> oldMessage <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'index 的变化'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> newIndex<span class="token punctuation">,</span> oldIndex <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>什么情况下可能会用到批量监听呢？比如一个子组件有多个 props ，当有任意一个 prop 发生变化时，都需要执行初始化函数重置组件的状态，那么这个时候就可以用上这个功能啦！</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在适当的业务场景，你也可以使用 <a href="#watchEffect">watchEffect</a> 来完成批量监听，但请留意 <a href="#%E5%92%8C-watch-%E7%9A%84%E5%8C%BA%E5%88%AB">功能区别</a> 部分的说明。</p></div> <h4 id="监听的选项"><a href="#监听的选项" class="header-anchor">#</a> 监听的选项</h4> <p>watch API 还接受第 3 个参数 <code>options</code> ，可选的一些监听选项。</p> <p><code>options</code> 是一个对象的形式传入，有以下几个选项：</p> <table><thead><tr><th style="text-align:center;">选项</th> <th style="text-align:center;">类型</th> <th style="text-align:center;">默认值</th> <th style="text-align:center;">可选值</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:center;">deep</td> <td style="text-align:center;">boolean</td> <td style="text-align:center;">false</td> <td style="text-align:center;">true | false</td> <td style="text-align:left;">是否进行深度监听</td></tr> <tr><td style="text-align:center;">immediate</td> <td style="text-align:center;">boolean</td> <td style="text-align:center;">false</td> <td style="text-align:center;">true | false</td> <td style="text-align:left;">是否立即执行监听回调</td></tr> <tr><td style="text-align:center;">flush</td> <td style="text-align:center;">string</td> <td style="text-align:center;">'pre'</td> <td style="text-align:center;">'pre' | 'post' | 'sync'</td> <td style="text-align:left;">控制监听回调的调用时机</td></tr> <tr><td style="text-align:center;">onTrack</td> <td style="text-align:center;">(e) =&gt; void</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:left;">在数据源被追踪时调用</td></tr> <tr><td style="text-align:center;">onTrigger</td> <td style="text-align:center;">(e) =&gt; void</td> <td style="text-align:center;"></td> <td style="text-align:center;"></td> <td style="text-align:left;">在监听回调被触发时调用</td></tr></tbody></table> <p>其中 <code>onTrack</code> 和 <code>onTrigger</code> 的 <code>e</code> 是 debugger 事件，建议在回调内放置一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/debugger" target="_blank" rel="noopener noreferrer">debugger 语句<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 以调试依赖，这两个选项仅在开发模式下生效。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>deep 默认是 <code>false</code> ，但是在监听 reactive 对象或数组时，会默认为 <code>true</code> ，详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">监听选项之 deep</a>。</p></div> <h4 id="监听选项之-deep"><a href="#监听选项之-deep" class="header-anchor">#</a> 监听选项之 deep</h4> <p><code>deep</code> 选项接受一个布尔值，可以设置为 <code>true</code> 开启深度监听，或者是 <code>false</code> 关闭深度监听，默认情况下这个选项是 <code>false</code> 关闭深度监听的，但也存在特例。</p> <p>设置为 <code>false</code> 的情况下，如果直接监听一个响应式的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures#%E5%AF%B9%E8%B1%A1" target="_blank" rel="noopener noreferrer">引用类型<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 数据（e.g. <code>Object</code> 、 <code>Array</code> … ），虽然它的属性的值有变化，但对其本身来说是不变的，所以不会触发 watch 的 callback 。</p> <p>下面是一个关闭了深度监听的例子：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个响应式数据，注意我是用的 ref 来定义</span>
    <span class="token keyword">const</span> nums <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后给这个数组添加项目</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      nums<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token comment">// 可以打印一下，确保数据确实变化了</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改后'</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// 但是这个 watch 不会按预期执行</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>
      nums<span class="token punctuation">,</span>
      <span class="token comment">// 这里的 callback 不会被触发</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'触发监听'</span><span class="token punctuation">,</span> nums<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 因为关闭了 deep</span>
      <span class="token punctuation">{</span>
        deep<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>类似这种情况，你需要把 <code>deep</code> 设置为 <code>true</code> 才可以触发监听。</p> <p>可以看到我的例子特地用了 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-ref-new">ref API</a> ，这是因为通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-reactive-new">reactive API</a> 定义的对象无法将 <code>deep</code> 成功设置为 <code>false</code> 。</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-ts"><code><span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getter</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> source
  deep <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 被强制开启了</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre></div><p>这个情况就是我说的 “特例” ，你可以通过 <code>isReactive</code> API 来判断是否需要手动开启深度监听。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 导入 isReactive API</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> isReactive<span class="token punctuation">,</span> reactive<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听这个数据时，会默认开启深度监听</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// true</span>

    <span class="token comment">// 监听这个数据时，不会默认开启深度监听</span>
    <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="监听选项之-immediate"><a href="#监听选项之-immediate" class="header-anchor">#</a> 监听选项之 immediate</h4> <p>在 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a> 部分有了解过， watch 默认是惰性的，也就是只有当被监听的数据源发生变化时才执行回调。</p> <p>这句话是什么意思呢？来看一下这段代码，为了减少 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">deep</a> 选项的干扰，我们换一个类型，换成 <code>string</code> 数据来演示，请留意我的注释：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这个时候不会触发 watch 的回调</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 来到这里才会触发 watch 的回调</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'触发监听'</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>可以看到，数据在初始化的时候并不会触发监听回调，如果有需要的话，通过 <code>immediate</code> 选项来让它直接触发。</p> <p><code>immediate</code> 选项接受一个布尔值，默认是 <code>false</code> ，你可以设置为 <code>true</code> 让回调立即执行。</p> <p>我们改成这样，请留意高亮的代码部分和新的注释：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这一次在这里可以会触发 watch 的回调了</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token comment">// 2s后改变数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这一次，这里是第二次触发 watch 的回调，不再是第一次</span>
      message<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token function">watch</span><span class="token punctuation">(</span>
      message<span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'触发监听'</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 设置 immediate 选项</span>
      <span class="token punctuation">{</span>
        immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>注意，在带有 immediate 选项时，不能在第一次回调时取消该数据源的监听，详见 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> 部分。</p> <h4 id="监听选项之-flush"><a href="#监听选项之-flush" class="header-anchor">#</a> 监听选项之 flush</h4> <p><code>flush</code> 选项是用来控制 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听回调</a> 的调用时机，接受指定的字符串，可选值如下，默认是 <code>'pre'</code> 。</p> <table><thead><tr><th style="text-align:center;">可选值</th> <th style="text-align:left;">回调的调用时机</th> <th style="text-align:left;">使用场景</th></tr></thead> <tbody><tr><td style="text-align:center;">'pre'</td> <td style="text-align:left;">将在渲染前被调用</td> <td style="text-align:left;">允许回调在模板运行前更新了其他值</td></tr> <tr><td style="text-align:center;">'sync'</td> <td style="text-align:left;">在渲染时被同步调用</td> <td style="text-align:left;">目前来说没什么好处，可以了解但不建议用…</td></tr> <tr><td style="text-align:center;">'post'</td> <td style="text-align:left;">被推迟到渲染之后调用</td> <td style="text-align:left;">如果要通过 ref 操作 <a href="#dom-%E5%85%83%E7%B4%A0%E4%B8%8E%E5%AD%90%E7%BB%84%E4%BB%B6">DOM 元素与子组件</a> ，需要使用这个值来启用该选项，以达到预期的执行效果</td></tr></tbody></table> <h4 id="停止监听"><a href="#停止监听" class="header-anchor">#</a> 停止监听</h4> <p>如果你在 <a href="#%E5%85%A8%E6%96%B0%E7%9A%84-setup-%E5%87%BD%E6%95%B0-new">setup</a> 或者 <a href="/document/efficient.html#script-setup-new">script-setup</a> 里使用 watch 的话， <a href="#%E7%BB%84%E4%BB%B6%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F-new">组件被卸载</a> 的时候也会一起被停止，一般情况下不太需要关心如何停止监听。</p> <p>不过有时候你可能想要手动取消， Vue 3 也提供了方法。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>随着组件被卸载一起停止的前提是，侦听器必须是 <a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing#%E5%90%8C%E6%AD%A5javascript" target="_blank" rel="noopener noreferrer">同步语句<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 创建的，这种情况下侦听器会绑定在当前组件上。</p> <p>如果放在 <code>setTimeout</code> 等 <a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Asynchronous/Introducing#%E5%BC%82%E6%AD%A5javascript" target="_blank" rel="noopener noreferrer">异步函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 里面创建，则不会绑定到当前组件，因此组件卸载的时候不会一起停止该侦听器，这种时候你就需要手动停止监听。</p></div> <p>当你在定义一个 watch 行为的时候，它会返回一个用来停止监听的函数。</p> <p>用法很简单，做一下简单了解即可：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 定义一个取消观察的变量，它是一个函数</span>
<span class="token keyword">const</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 在合适的时期调用它，可以取消这个监听</span>
<span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>但是也有一点需要注意的是，如果你启用了 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-immediate">immediate  选项</a> ，不能在第一次触发监听回调时执行它。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 注意：这是一段错误的代码，运行会报错</span>
<span class="token keyword">const</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听的回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 在这里调用会有问题 ❌</span>
    <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 启用 immediate 选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>你会收获一段报错，告诉你 <code>unwatch</code> 这个变量在初始化前无法被访问：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>Uncaught ReferenceError: Cannot access <span class="token string">'unwatch'</span> before initialization
</code></pre></div><p>目前有两种方案可以让你实现这个操作：</p> <p>方案一：使用 <code>var</code> 并判断变量类型，利用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/var#%E6%8F%8F%E8%BF%B0" target="_blank" rel="noopener noreferrer">var 的变量提升<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来实现目的。</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// 这里改成 var ，不要用 const 或 let</span>
<span class="token keyword">var</span> unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里加一个判断，是函数才执行它</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 监听选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>不过 <code>var</code> 已经属于过时的语句了，建议用方案二的 <code>let</code> 。</p> <p>方案二：使用 <code>let</code> 并判断变量类型。</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token comment">// 如果不想用 any ，可以导入 TS 类型</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> WatchStopHandle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 这里改成 let ，但是要另起一行，先定义，再赋值</span>
<span class="token keyword">let</span> unwatch<span class="token operator">:</span> WatchStopHandle
unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token comment">// 监听回调</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里加一个判断，是函数才执行它</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 监听选项</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h4 id="监听效果清理"><a href="#监听效果清理" class="header-anchor">#</a> 监听效果清理</h4> <p>在 <a href="#%E7%9B%91%E5%90%AC%E5%90%8E%E7%9A%84%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0">监听后的回调函数</a> 部分提及到一个参数 <code>onCleanup</code> ，它可以帮你注册一个清理函数。</p> <p>有时 watch 的回调会执行异步操作，当 watch 到数据变更的时候，需要取消这些操作，这个函数的作用就用于此，会在以下情况调用这个清理函数：</p> <ul><li>watcher 即将重新运行的时候</li> <li>watcher 被停止（组件被卸载或者被手动 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> ）</li></ul> <p>用法方面比较简单，传入一个回调函数运行即可，不过需要注意的是，需要在停止监听之前注册好清理行为，否则不会生效。</p> <p>我们在 <a href="#%E5%81%9C%E6%AD%A2%E7%9B%91%E5%90%AC">停止监听</a> 里的最后一个 immediate 例子的基础上继续添加代码，请注意注册的时机：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-ts"><code><span class="token keyword">let</span> unwatch<span class="token operator">:</span> WatchStopHandle
unwatch <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>
  message<span class="token punctuation">,</span>
  <span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> onCleanup<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要在停止监听之前注册好清理行为</span>
    <span class="token function">onCleanup</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'监听清理ing'</span><span class="token punctuation">)</span>
      <span class="token comment">// 根据实际的业务情况定义一些清理操作 ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 然后再停止监听</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> unwatch <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    immediate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="watcheffect"><a href="#watcheffect" class="header-anchor">#</a> watchEffect</h3> <p>如果一个函数里包含了多个需要监听的数据，一个一个数据去监听太麻烦了，在 Vue 3 ，你可以直接使用 watchEffect API 来简化你的操作。</p> <h4 id="用法示例"><a href="#用法示例" class="header-anchor">#</a> 用法示例</h4> <p>它立即执行传入的一个函数，同时响应式追踪其依赖，并在其依赖变更时重新运行该函数。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watchEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 单独定义两个数据，后面用来分开改变数值</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Petter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 定义一个调用这两个数据的函数</span>
    <span class="token keyword">const</span> getUserInfo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> name<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        age<span class="token operator">:</span> age<span class="token punctuation">.</span>value
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2s后改变第一个数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4s后改变第二个数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      age<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 直接监听调用函数，在每个数据产生变化的时候，它都会自动执行</span>
    <span class="token function">watchEffect</span><span class="token punctuation">(</span>getUserInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="和-watch-的区别"><a href="#和-watch-的区别" class="header-anchor">#</a> 和 watch 的区别</h4> <p>虽然理论上 <code>watchEffect</code> 是 <code>watch</code> 的一个简化操作，可以用来代替 <a href="#%E6%89%B9%E9%87%8F%E7%9B%91%E5%90%AC">批量监听</a> ，但它们也有一定的区别：</p> <ol><li><p><code>watch</code> 可以访问侦听状态变化前后的值，而 <code>watchEffect</code> 没有。</p></li> <li><p><code>watch</code> 是在属性改变的时候才执行，而 <code>watchEffect</code> 则默认会执行一次，然后在属性改变的时候也会执行。</p></li></ol> <p>第二点的意思，看下面这段代码可以有更直观的理解：</p> <p>使用 watch ：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 使用 watch 需要先手动执行一次</span>
    <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 然后当 foo 有变动时，才会通过 watch 来执行 bar()</span>
    <span class="token function">watch</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> bar<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用 watchEffect ：</p> <div class="language-ts extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      foo<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hello World!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>foo<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 可以通过 watchEffect 实现 bar() + watch(foo, bar) 的效果</span>
    <span class="token function">watchEffect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="可用的监听选项"><a href="#可用的监听选项" class="header-anchor">#</a> 可用的监听选项</h4> <p>虽然用法和 watch 类似，但也简化了一些选项，它的监听选项 TS 类型如下：</p> <p>它不支持 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-deep">deep</a> 和 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-immediate">immediate</a> ，请记住这一点，其他的用法是一样的。</p> <p><code>flush</code> 选项的使用详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> ，<code>onTrack</code> 和 <code>onTrigger</code> 详见 <a href="#%E7%9B%91%E5%90%AC%E7%9A%84%E9%80%89%E9%A1%B9">监听的选项</a> 部分内容。</p> <h3 id="watchposteffect"><a href="#watchposteffect" class="header-anchor">#</a> watchPostEffect</h3> <p><a href="#watchEffect">watchEffect</a> API 使用 <code>flush: 'post'</code> 选项时的别名，具体区别详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> 部分。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Vue v3.2.0 及以上版本才支持该 API 。</p></div> <h3 id="watchsynceffect"><a href="#watchsynceffect" class="header-anchor">#</a> watchSyncEffect</h3> <p><a href="#watchEffect">watchEffect</a> API 使用 <code>flush: 'sync'</code> 选项时的别名，具体区别详见 <a href="#%E7%9B%91%E5%90%AC%E9%80%89%E9%A1%B9%E4%B9%8B-flush">监听选项之 flush</a> 部分。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Vue v3.2.0 及以上版本才支持该 API 。</p></div> <h2 id="数据的计算"><a href="#数据的计算" class="header-anchor">#</a> 数据的计算</h2> <p>和 Vue 2.0 一样，数据的计算也是使用 <code>computed</code> API ，它可以通过现有的响应式数据，去通过计算得到新的响应式变量，用过 Vue 2.0 的同学应该不会太陌生，但是在 Vue 3.0 ，在使用方式上也是变化非常大！</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这里的响应式数据，可以简单理解为通过 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-ref-new">ref</a> API 、 <a href="#%E5%93%8D%E5%BA%94%E5%BC%8F-api-%E4%B9%8B-reactive-new">reactive</a> API 定义出来的数据，当然 Vuex 、Vue Router 等 Vue 数据也都具备响应式。</p></div> <h3 id="用法变化"><a href="#用法变化" class="header-anchor">#</a> 用法变化</h3> <p>我们先从一个简单的用例来看看在 Vue 新旧版本的用法区别：</p> <p>假设你定义了两个分开的数据 <code>firstName</code> 名字和 <code>lastName</code> 姓氏，但是在 template 展示时，需要展示完整的姓名，那么你就可以通过 <code>computed</code> 来计算一个新的数据：</p> <h4 id="回顾-vue-2-2"><a href="#回顾-vue-2-2" class="header-anchor">#</a> 回顾 Vue 2</h4> <p>在 Vue 2.0 ，<code>computed</code> 和 <code>data</code> 在同级配置，并且不可以和 <code>data</code> 里的数据同名重复定义：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 在 Vue 2 的写法：</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      firstName<span class="token operator">:</span> <span class="token string">'Bill'</span><span class="token punctuation">,</span>
      lastName<span class="token operator">:</span> <span class="token string">'Gates'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 注意这里定义的变量，都要通过函数的形式来返回它的值</span>
  computed<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 普通函数可以直接通过熟悉的 this 来拿到 data 里的数据</span>
    <span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 箭头函数则需要通过参数来拿到实例上的数据</span>
    <span class="token function-variable function">fullName2</span><span class="token operator">:</span> <span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样你在需要用到全名的地方，只需要通过 <code>this.fullName</code> 就可以得到 <code>Bill Gates</code> 。</p> <h4 id="了解-vue-3-2"><a href="#了解-vue-3-2" class="header-anchor">#</a> 了解 Vue 3</h4> <p>在 Vue 3.0 ，跟其他 API 的用法一样，需要先导入 <code>computed</code> 才能使用：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 在 Vue 3 的写法：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义基本的数据</span>
    <span class="token keyword">const</span> firstName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Bill'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> lastName <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Gates'</span><span class="token punctuation">)</span>

    <span class="token comment">// 定义需要计算拼接结果的数据</span>
    <span class="token keyword">const</span> fullName <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

    <span class="token comment">// 2s 后改变某个数据的值</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      firstName<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Petter'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>

    <span class="token comment">// template 那边在 2s 后也会显示为 Petter Gates</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      fullName<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你可以把这个用法简单的理解为，传入一个回调函数，并 <code>return</code> 一个值，对，它需要有明确的返回值。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>需要注意的是：</p> <ol><li><p>定义出来的 <code>computed</code> 变量，和 <code>ref</code> 变量的用法一样，也是需要通过 <code>.value</code> 才能拿到它的值</p></li> <li><p>但是区别在于， <code>computed</code> 的 <code>value</code> 是只读的</p></li></ol> <p>原因详见下方的 <a href="#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89">类型定义</a> 。</p></div> <h3 id="类型定义"><a href="#类型定义" class="header-anchor">#</a> 类型定义</h3> <p>我们之前说过，在 <a href="#%E4%BA%86%E8%A7%A3-definecomponent">defineComponent</a> 里，会自动帮我们推导 Vue API 的类型，所以一般情况下，你是不需要显式的去定义 <code>computed</code> 出来的变量类型的。</p> <p>在确实需要手动指定的情况下，你也可以导入它的类型然后定义：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> computed <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> ComputedRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token comment">// 注意这里添加了类型定义</span>
<span class="token keyword">const</span> fullName<span class="token operator">:</span> ComputedRef<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>firstName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>lastName<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
</code></pre></div><p>你要返回一个字符串，你就写 <code>ComputedRef&lt;string&gt;</code> ；返回布尔值，就写 <code>ComputedRef&lt;boolean&gt;</code> ；返回一些复杂对象信息，你可以先定义好你的类型，再诸如 <code>ComputedRef&lt;UserInfo&gt;</code> 去写。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 这是 ComputedRef 的类型定义：</span>
<span class="token keyword">export</span> <span class="token keyword">declare</span> <span class="token keyword">interface</span> <span class="token class-name">ComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">WritableComputedRef<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span>ComoutedRefSymbol<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="优势对比和注意事项"><a href="#优势对比和注意事项" class="header-anchor">#</a> 优势对比和注意事项</h3> <p>在继续往下看之前，我们先来了解一下这个 API 的一些优势和注意事项（如果在 Vue 2 已经有接触过的话，可以跳过这一段，因为优势和需要注意的东西比较一致）。</p> <h4 id="优势对比"><a href="#优势对比" class="header-anchor">#</a> 优势对比</h4> <p>看到这里，相信刚接触的同学可能会有疑问，既然 <code>computed</code> 也是通过一个函数来返回值，那么和普通的 <code>function</code> 有什么区别，或者说优势？</p> <ol><li>性能优势</li></ol> <p>这一点在 <a href="https://v3.cn.vuejs.org/guide/computed.html#%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E7%BC%93%E5%AD%98-vs-%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">官网文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 其实是有提到的：</p> <blockquote><p>数据的计算是基于它们的响应依赖关系缓存的，只在相关响应式依赖发生改变时它们才会重新求值。</p></blockquote> <p>也就是说，只要原始数据没有发生改变，多次访问 <code>computed</code> ，都是会立即返回之前的计算结果，而不是再次执行函数；而普通的 <code>function</code> 调用多少次就执行多少次，每调用一次就计算一次。</p> <p>至于为何要如此设计，官网文档也给出了原因：</p> <blockquote><p>我们为什么需要缓存？假设我们有一个性能开销比较大的计算数据 list，它需要遍历一个巨大的数组并做大量的计算。然后我们可能有其他的计算数据依赖于 list。如果没有缓存，我们将不可避免的多次执行 list 的 getter！如果你不希望有缓存，请用 function 来替代。</p></blockquote> <ol start="2"><li>书写统一</li></ol> <p>我们假定 foo1 是 <code>ref</code> 变量， foo2 是 <code>computed</code> 变量， foo3 是普通函数返回值</p> <p>看到这里的同学应该都已经清楚 Vue 3 的 <code>ref</code> 变量是通过 <code>foo1.value</code> 来拿到值的，而 <code>computed</code> 也是通过 <code>foo2.value</code> ，并且在 template 里都可以省略 <code>.value</code> ，在读取方面，他们是有一致的风格和简洁性。</p> <p>而 foo3 不管是在 script 还是 template ，都需要通过 <code>foo3()</code> 才能拿到结果，相对来说会有那么一丢丢别扭。</p> <p>当然，关于这一点，如果涉及到的数据不是响应式数据，那么还是老老实实的用函数返回值吧，原因请见下面的 <a href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">注意事项</a> 。</p> <h4 id="注意事项"><a href="#注意事项" class="header-anchor">#</a> 注意事项</h4> <p>有优势当然也就有一定的 “劣势” ，当然这也是 Vue 框架的有意为之，所以在使用上也需要注意一些问题：</p> <ol><li>只会更新响应式数据的计算</li></ol> <p>假设你要获取当前的时间信息，因为不是响应式数据，所以这种情况下你就需要用普通的函数去获取返回值，才能拿到最新的时间。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> nowTime <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token comment">// 输出 Sun Nov 14 2021 21:07:00 GMT+0800 (GMT+08:00)</span>

<span class="token comment">// 2s 后依然是跟上面一样的结果</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nowTime<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  <span class="token comment">// 还是输出 Sun Nov 14 2021 21:07:00 GMT+0800 (GMT+08:00)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>数据是只读的</li></ol> <p>通过 computed 定义的数据，它是只读的，这一点在 <a href="#%E7%B1%BB%E5%9E%8B%E5%AE%9A%E4%B9%89">类型定义</a> 已经有所了解。</p> <p>如果你直接赋值，不仅无法变更数据，而且会收获一个报错。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>TS2540: Cannot assign to <span class="token string">'value'</span> because it is a read-only property.
</code></pre></div><p>虽然无法直接赋值，但是在必要的情况下，你依然可以通过 <code>computed</code> 的 <code>setter</code> 来更新数据。</p> <p>点击了解：<a href="#setter-%E7%9A%84%E4%BD%BF%E7%94%A8">computed 的 setter 用法</a></p> <h3 id="setter-的使用"><a href="#setter-的使用" class="header-anchor">#</a> setter 的使用</h3> <p>通过 computed 定义的变量默认都是只读的形式（只有一个 getter ），但是在必要的情况下，你也可以使用其 setter 属性来更新数据。</p> <h4 id="基本格式"><a href="#基本格式" class="header-anchor">#</a> 基本格式</h4> <p>当你需要用到 setter 的时候， <code>computed</code> 就不再是一个传入 callback 的形式了，而是传入一个带有 2 个方法的对象。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 注意这里computed接收的入参已经不再是函数</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 这里需要明确的返回一个值</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 这里接收一个参数，代表修改 foo 时，赋值下来的新值</span>
  <span class="token function">set</span><span class="token punctuation">(</span>newValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里的 <code>get</code> 就是 <code>computed</code> 的 getter ，跟原来传入 callback 的形式一样，是用于 <code>foo.value</code> 的读取，所以这里你必须有明确的返回值。</p> <p>这里的 <code>set</code> 就是 <code>computed</code> 的 setter ，它会接收一个参数，代表新的值，当你通过 <code>foo.value = xxx</code> 赋值的时候，赋入的这个值，就会通过这个入参来传递进来，你可以根据你的业务需要，把这个值，赋给相关的数据源。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>请注意，必须使用 <code>get</code> 和 <code>set</code> 这 2 个方法名，也只接受这 2 个方法。</p></div> <h2 id="css-样式与预处理器"><a href="#css-样式与预处理器" class="header-anchor">#</a> CSS 样式与预处理器</h2> <p>Vue 组件的 CSS 样式部分，3.x 保留着和 2.x 完全一样的写法。</p> <h3 id="编写组件样式表"><a href="#编写组件样式表" class="header-anchor">#</a> 编写组件样式表</h3> <p>最基础的写法，就是在 Vue 文件里创建一个 <code>style</code> 标签，即可在里面写 CSS 代码了。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="动态绑定-css"><a href="#动态绑定-css" class="header-anchor">#</a> 动态绑定 CSS</h3> <p>动态绑定 CSS ，在 Vue 2 就已经存在了，在此之前常用的是 <code>:class</code> 和 <code>:style</code> ，现在在 Vue 3 ，还可以通过 <code>v-bind</code> 来动态修改了。</p> <p>其实这一部分主要是想说一下 3.x 新增的 <code>&lt;style&gt; v-bind</code> 功能，不过既然写到这里，就把另外两个动态绑定方式也一起提一下。</p> <h4 id="使用-class-动态修改样式名"><a href="#使用-class-动态修改样式名" class="header-anchor">#</a> 使用 :class 动态修改样式名</h4> <p>它是绑定在 DOM 元素上面的一个属性，跟 <code>class</code> 同级别，它非常灵活！</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>使用 <code>:class</code> 是用来动态修改样式名，也就意味着你必须提前把样式名对应的样式表先写好！</p></div> <p>假设我们已经提前定义好了这几个变量：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> activeClass <span class="token operator">=</span> <span class="token string">'active-class'</span>
    <span class="token keyword">const</span> activeClass1 <span class="token operator">=</span> <span class="token string">'active-class1'</span>
    <span class="token keyword">const</span> activeClass2 <span class="token operator">=</span> <span class="token string">'active-class2'</span>
    <span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      activeClass<span class="token punctuation">,</span>
      activeClass1<span class="token punctuation">,</span>
      activeClass2<span class="token punctuation">,</span>
      isActive<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果只想绑定一个单独的动态样式，你可以传入一个字符串：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>activeClass<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果有多个动态样式，也可以传入一个数组：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[activeClass1, activeClass2]<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你还可以对动态样式做一些判断，这个时候传入一个对象：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ <span class="token punctuation">'</span>active-class<span class="token punctuation">'</span>: isActive }<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>多个判断的情况下，记得也用数组套起来：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[
      { activeClass1: isActive },
      { activeClass2: !isActive }
    ]<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么什么情况下会用到 <code>:class</code> 呢？</p> <p>最常见的场景，应该就是导航、选项卡了，比如你要给一个当前选中的选项卡做一个突出高亮的状态，那么就可以使用 <code>:class</code> 来动态绑定一个样式。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>list<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>item<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{ cur: index === curIndex }<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>(item, index) in 5<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>curIndex = index<span class="token punctuation">&quot;</span></span>
    <span class="token punctuation">&gt;</span></span>
      {{ item }}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> curIndex <span class="token operator">=</span> ref<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      curIndex<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.cur</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样就简单实现了一个点击切换选项卡高亮的功能。</p> <h4 id="使用-style-动态修改内联样式"><a href="#使用-style-动态修改内联样式" class="header-anchor">#</a> 使用 :style 动态修改内联样式</h4> <p>如果你觉得使用 <code>:class</code> 需要提前先写样式，再去绑定样式名有点繁琐，有时候只想简简单单的修改几个样式，那么你可以通过 <code>:style</code> 来处理。</p> <p>默认的情况下，我们都是传入一个对象去绑定：</p> <ul><li><p><code>key</code> 是符合 CSS 属性名的 “小驼峰式” 写法，或者套上引号的短横线分隔写法（原写法），例如在 CSS 里，定义字号是 <code>font-size</code> ，那么你需要写成 <code>fontSize</code> 或者 <code>'font-size'</code> 作为它的键。</p></li> <li><p><code>value</code> 是 CSS 属性对应的 “合法值”，比如你要修改字号大小，可以传入 <code>13px</code> 、<code>0.4rem</code> 这种带合法单位字符串值，但不可以是 <code>13</code> 这样的缺少单位的值，无效的 CSS 值会被过滤不渲染。</p></li></ul> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{
      fontSize: <span class="token punctuation">'</span>13px<span class="token punctuation">'</span>,
      <span class="token punctuation">'</span>line-height<span class="token punctuation">'</span>: 2,
      color: <span class="token punctuation">'</span>#ff0000<span class="token punctuation">'</span>,
      textAlign: <span class="token punctuation">'</span>center<span class="token punctuation">'</span>
    }<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果有些特殊场景需要绑定多套 <code>style</code>，你需要在 <code>script</code> 先定义好各自的样式变量（也是符合上面说到的那几个要求的对象），然后通过数组来传入：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
    <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>[style1, style2]<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">&gt;</span></span>
    Hello World!
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style1 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">fontSize</span><span class="token operator">:</span> <span class="token string">'13px'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'line-height'</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> style2 <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'#ff0000'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">textAlign</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      style1<span class="token punctuation">,</span>
      style2<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="使用-v-bind-动态修改-style"><a href="#使用-v-bind-动态修改-style" class="header-anchor">#</a> 使用 v-bind 动态修改 style</h4> <p>当然，以上两种形式都是关于 <code>&lt;script /&gt;</code> 和 <code>&lt;template /&gt;</code> 部分的相爱相杀，如果你觉得会给你的模板带来一定的维护成本的话，不妨考虑这个新方案，将变量绑定到 <code>&lt;style /&gt;</code> 部分去。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>请注意这是一个在 <code>3.2.0</code> 版本之后才被归入正式队列的新功能！</p> <p>如果需要使用它，请确保你的 <code>vue</code> 和 <code>@vue/compiler-sfc</code> 版本号在 <code>3.2.0</code> 以上，最好是保持最新的 <code>@next</code> 版本。</p></div> <p>我们先来看看基本的用法：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fontColor <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">'#ff0000'</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      fontColor<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">v-bind</span><span class="token punctuation">(</span>fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如上面的代码，你将渲染出一句红色文本的 <code>Hello World!</code></p> <p>这其实是利用了现代浏览器支持的 CSS 变量来实现的一个功能（所以如果你打算用它的话，需要提前注意一下兼容性噢，点击查看：<a href="https://caniuse.com/css-variables" target="_blank" rel="noopener noreferrer">CSS Variables 兼容情况<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <p>它渲染到 DOM 上，其实也是通过绑定 <code>style</code> 来实现，我们可以看到渲染出来的样式是：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-v-7eb2bc79</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>
  <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">--7eb2bc79-fontColor</span><span class="token punctuation">:</span>#ff0000<span class="token punctuation">;</span></span><span class="token punctuation">&quot;</span></span></span>
<span class="token punctuation">&gt;</span></span>
  Hello World!
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对应的 CSS 变成了：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.msg[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--7eb2bc79-fontColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>理论上 <code>v-bind</code> 函数可以在 Vue 内部支持任意的 JS 表达式，但由于可能包含在 CSS 标识符中无效的字符，因此官方是建议在大多数情况下，用引号括起来，如：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token function">v-bind</span><span class="token punctuation">(</span><span class="token string">'theme.font.size'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于 CSS 变量的特性，因此对 CSS 响应式属性的更改不会触发模板的重新渲染（这也是和 <code>:class</code> 与 <code>:style</code> 的最大不同）。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>不管你有没有开启 <a href="#style-scoped">&lt;style scoped&gt;</a> ，使用 <code>v-bind</code> 渲染出来的 CSS 变量，都会带上 <code>scoped</code> 的随机 hash 前缀，避免样式污染（永远不会意外泄漏到子组件中），所以请放心使用！</p></div> <p>如果你对 CSS 变量的使用还不是很了解的话，可以先阅读一下相关的基础知识点。</p> <p>相关阅读：<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Using_CSS_custom_properties" target="_blank" rel="noopener noreferrer">使用CSS自定义属性（变量） - MDN<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="样式表的组件作用域"><a href="#样式表的组件作用域" class="header-anchor">#</a> 样式表的组件作用域</h3> <p>CSS 不像 JS ，是没有作用域的概念的，一旦写了某个样式，直接就是全局污染。所以 <a href="https://www.bemcss.com/" target="_blank" rel="noopener noreferrer">BEM 命名法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等规范才应运而生。</p> <p>但在 Vue 组件里，有两种方案可以避免出现这种污染问题。</p> <p>一个是 Vue 2 就有的 <code>&lt;style scoped&gt;</code> ，一个是 Vue 3 新推出的 <code>&lt;style module&gt;</code> 。</p> <h4 id="style-scoped"><a href="#style-scoped" class="header-anchor">#</a> style scoped</h4> <p>Vue 组件在设计的时候，就想到了一个很优秀的解决方案，通过 <code>scoped</code> 来支持创建一个 CSS 作用域，使这部分代码只运行在这个组件渲染出来的虚拟 DOM 上。</p> <p>使用方式很简单，只需要在 <code>style</code> 后面带上 <code>scoped</code> 属性。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>编译后，虚拟 DOM 都会带有一个 <code>data-v-xxxxx</code> 这样的属性，其中 <code>xxxxx</code> 是一个随机生成的 hash ，同一个组件的 hash 是相同并且唯一的：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-v-7eb2bc79</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">data-v-7eb2bc79</span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>而 CSS 则也会带上与 HTML 相同的属性，从而达到样式作用域的目的。</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.msg[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.msg p[data-v-7eb2bc79]</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用 <code>scoped</code> 可以有效的避免全局样式污染，你可以在不同的组件里面都使用相同的 className，而不必担心会相互覆盖，不必再定义很长很长的样式名来防止冲突了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>添加 <code>scoped</code> 生成的样式，只作用于当前组件中的元素，并且权重高于全局 CSS ，可以覆盖全局样式</p></div> <h4 id="style-module"><a href="#style-module" class="header-anchor">#</a> style module</h4> <p>这是在 Vue 3 才推出的一个新方案，和 <code>&lt;style scoped&gt;</code> 不同，scoped 是通过给 DOM 元素添加自定义属性的方式来避免冲突，而 <code>&lt;style module&gt;</code> 则更为激进，将会编译成 <a href="https://github.com/css-modules/css-modules" target="_blank" rel="noopener noreferrer">CSS Modules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。</p> <p>对于 CSS Modules 的处理方式，我们也可以通过一个小例子来更直观的了解它：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* 编译前 */</span>
<span class="token selector">.title</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 编译后 */</span>
<span class="token selector">._3zyde4l1yATCOkgn-DBWEL</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看出，是通过比较 “暴力” 的方式，把我们编写的 “好看的” 样式名，直接改写成一个随机 hash 样式名，来避免样式互相污染。</p> <blockquote><p>上面的案例来自阮老师的博文 <a href="https://www.ruanyifeng.com/blog/2016/06/css_modules.html" target="_blank" rel="noopener noreferrer">CSS Modules 用法教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>所以我们回到 Vue 这边，看看 <code>&lt;style module&gt;</code> 是怎么操作的。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>于是，你将渲染出一句红色文本的 <code>Hello World!</code> 。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>使用这个方案，需要了解如何 <a href="#%E4%BD%BF%E7%94%A8-class-%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E6%A0%B7%E5%BC%8F%E5%90%8D">使用 :class 动态修改样式名</a></p></li> <li><p>如果单纯只使用 <code>&lt;style module&gt;</code> ，那么在绑定样式的时候，是默认使用 <code>$style</code> 对象来操作的</p></li> <li><p>必须显示的指定绑定到某个样式，比如 <code>$style.msg</code> ，才能生效</p></li> <li><p>如果单纯的绑定 <code>$style</code> ，并不能得到 “把全部样式名直接绑定” 的期望结果</p></li> <li><p>如果你指定的 className 是短横杆命名，比如 <code>.user-name</code> ，那么需要通过 <code>$style['user-name']</code> 去绑定</p></li></ol></div> <p>你也可以给 <code>module</code> 进行命名，然后就可以通过你命名的 “变量名” 来操作：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>需要注意的一点是，一旦开启 <code>&lt;style module&gt;</code> ，那么在 <code>&lt;style module&gt;</code> 里所编写的样式，都必须手动绑定才能生效，没有被绑定的样式，会被编译，但不会主动生效到你的 DOM 上。</p> <p>原因是编译出来的样式名已经变化，而你的 DOM 未指定对应的样式名，或者指定的是编译前的命名，所以并不能匹配到正确的样式。</p></div> <h4 id="usecssmodule"><a href="#usecssmodule" class="header-anchor">#</a> useCssModule</h4> <p>这是一个全新的 API ，面向在 script 部分操作 CSS Modules 。</p> <p>在上面的 <a href="#style-module-new">CSS Modules</a> 部分可以知道，你可以在 <code>style</code> 定义好样式，然后在 <code>template</code> 部分通过变量名来绑定样式。</p> <p>那么如果有一天有个需求，你需要通过 <code>v-html</code> 来渲染 HTML 代码，那这里的样式岂不是凉凉了？当然不会！</p> <p>Vue 3 提供了一个 Composition API <code>useCssModule</code> 来帮助你在 <code>setup</code> 函数里操作你的 CSS Modules （对，只能在 <a href="#%E5%85%A8%E6%96%B0%E7%9A%84-setup-%E5%87%BD%E6%95%B0-new">setup</a> 或者 <a href="/document/efficient.html#script-setup-new">script setup</a> 里使用）。</p> <p><strong>基本用法：</strong></p> <p>我们绑定多几个样式，再来操作：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.msg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>$style.text<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Hello World!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> useCssModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>可以看到打印出来的 <code>style</code> 是一个对象：</p> <ul><li><p><code>key</code> 是你在 <code>&lt;style modules&gt;</code> 里定义的原始样式名</p></li> <li><p><code>value</code> 则是编译后的新样式名</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'home_msg_37Xmr'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'home_text_2woQJ'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>所以我们来配合 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Template_literals" target="_blank" rel="noopener noreferrer">模板字符串<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的使用，看看刚刚说的，要通过 <code>v-html</code> 渲染出来的内容应该如何绑定样式：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-html</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ts<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> useCssModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取样式</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 编写模板内容</span>
    <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>style<span class="token punctuation">.</span>msg<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;
      &lt;span class=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>style<span class="token punctuation">.</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;Hello World! —— from v-html&lt;/span&gt;
    &lt;/p&gt;</span><span class="token template-punctuation string">`</span></span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      content<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.msg</span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #ff0000<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.text</span> <span class="token punctuation">{</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>是不是也非常简单？可能刚开始不太习惯，但写多几次其实也蛮好玩的这个功能！</p> <p><strong>另外，需要注意的是，如果你是指定了 modules 的名称，那么必须传入对应的名称作为入参才可以正确拿到这些样式：</strong></p> <p>比如指定了一个 classes 作为名称：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">module</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classes<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token comment">/* ... */</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么需要通过传入 classes 这个名称才能拿到样式，否则会是一个空对象：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">useCssModule</span><span class="token punctuation">(</span><span class="token string">'classes'</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在 <code>const style = useCssModule()</code> 的时候，命名是随意的，跟你在 <code>&lt;style module=&quot;classes&quot;&gt;</code> 这里指定的命名没有关系。</p></div> <h3 id="深度操作符"><a href="#深度操作符" class="header-anchor">#</a> 深度操作符</h3> <p>在 <a href="#%E6%A0%B7%E5%BC%8F%E8%A1%A8%E7%9A%84%E7%BB%84%E4%BB%B6%E4%BD%9C%E7%94%A8%E5%9F%9F">样式表的组件作用域</a> 部分我们了解到，使用 scoped 后，父组件的样式将不会渗透到子组件中，但也不能直接修改子组件的样式。</p> <p>如果确实需要进行修改子组件的样式，必须通过 <code>::v-deep</code>（完整写法） 或者 <code>:deep</code>（快捷写法） 操作符来实现。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>旧版的深度操作符是 <code>&gt;&gt;&gt;</code> 、 <code>/deep/</code> 和 <code>::v-deep</code>，现在 <code>&gt;&gt;&gt;</code> 和 <code>/deep/</code> 已进入弃用阶段（虽然暂时还没完全移除）</p></li> <li><p>同时需要注意的是，旧版 <code>::v-deep</code> 的写法是作为组合器的方式，写在样式或者元素前面，如：<code>::v-deep .class-name { /* ... */ }</code>，现在这种写法也废弃了。</p></li></ol></div> <p>现在不论是 <code>::v-deep</code> 还是 <code>:deep</code> ，使用方法非常统一，我们来假设 .b 是子组件的样式名：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.a :deep(.b)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>编译后：</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.a[data-v-f3f3eg9] .b</span> <span class="token punctuation">{</span>
  <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>可以看到，新的 deep 写法是作为一个类似 JS “函数” 那样去使用，需要深度操作的样式或者元素名，作为 “入参” 去传入。</p></div> <p>同理，如果你使用 Less 或者 Stylus 这种支持嵌套写法的预处理器，也是可以这样去深度操作的：</p> <div class="language-less extra-class"><pre class="language-less"><code><span class="token selector">.a</span> <span class="token punctuation">{</span>
  <span class="token selector">:deep(.b)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* ... */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，除了操作子组件的样式，那些通过 <code>v-html</code> 创建的 DOM 内容，也不受作用域内的样式影响，也可以通过深度操作符来实现样式修改。</p> <h2 id="组件之间的通信"><a href="#组件之间的通信" class="header-anchor">#</a> 组件之间的通信</h2> <table><thead><tr><th style="text-align:left;">通信场景</th> <th style="text-align:left;">快速定位</th></tr></thead> <tbody><tr><td style="text-align:left;">父子组件通信</td> <td style="text-align:left;"><a href="#%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">点击查看</a></td></tr> <tr><td style="text-align:left;">爷孙组件通信</td> <td style="text-align:left;"><a href="#%E7%88%B7%E5%AD%99%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">点击查看</a></td></tr> <tr><td style="text-align:left;">兄弟组件通信</td> <td style="text-align:left;"><a href="#%E5%85%84%E5%BC%9F%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">点击查看</a></td></tr> <tr><td style="text-align:left;">全局组件通信</td> <td style="text-align:left;"><a href="#%E5%85%A8%E5%B1%80%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">点击查看</a></td></tr></tbody></table> <h2 id="父子组件通信"><a href="#父子组件通信" class="header-anchor">#</a> 父子组件通信</h2> <p>父子组件通信是指，B 组件引入到 A 组件里渲染，此时 A 是 B 的父级；B 组件的一些数据需要从A组件拿，B 组件有时也要告知 A 组件一些数据变化情况。</p> <p>他们之间的关系如下，<code>Child.vue</code> 是直接挂载在 <code>Father.vue</code> 下面：</p> <div class="language- extra-class"><pre class="language-text"><code>Father.vue
└─Child.vue
</code></pre></div><p>常用的方法有：</p> <table><thead><tr><th style="text-align:left;">方案</th> <th style="text-align:left;">父组件向子组件</th> <th style="text-align:left;">子组件向父组件</th> <th style="text-align:left;">对应章节传送门</th></tr></thead> <tbody><tr><td style="text-align:left;">props / emits</td> <td style="text-align:left;">props</td> <td style="text-align:left;">emits</td> <td style="text-align:left;"><a href="#props-emits">点击查看</a></td></tr> <tr><td style="text-align:left;">v-model / emits</td> <td style="text-align:left;">v-model</td> <td style="text-align:left;">emits</td> <td style="text-align:left;"><a href="#v-model-emits">点击查看</a></td></tr> <tr><td style="text-align:left;">ref / emits</td> <td style="text-align:left;">ref</td> <td style="text-align:left;">emits</td> <td style="text-align:left;"><a href="#ref-emits">点击查看</a></td></tr> <tr><td style="text-align:left;">provide / inject</td> <td style="text-align:left;">provide</td> <td style="text-align:left;">inject</td> <td style="text-align:left;"><a href="#provide-inject">点击查看</a></td></tr> <tr><td style="text-align:left;">EventBus</td> <td style="text-align:left;">emit / on</td> <td style="text-align:left;">emit / on</td> <td style="text-align:left;"><a href="#eventbus-new">点击查看</a></td></tr></tbody></table> <p>为了方便阅读，下面的父组件统一叫 <code>Father.vue</code>，子组件统一叫 <code>Child.vue</code>。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>在 2.x，有的同学可能喜欢用 <code>$attrs / $listeners</code> 来进行通信，但该方案在 3.x 已经移除了，详见 <a href="https://v3.cn.vuejs.org/guide/migration/listeners-removed.html" target="_blank" rel="noopener noreferrer">移除 $listeners<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="props-emits"><a href="#props-emits" class="header-anchor">#</a> props / emits</h2> <p>这是Vue跨组件通信最常用，也是基础的一个方案，它的通信过程是：</p> <ol><li><p><code>Father.vue</code> 通过 <code>prop</code> 向 <code>Child.vue</code> 传值（可包含父级定义好的函数）</p></li> <li><p><code>Child.vue</code> 通过 <code>emit</code> 向 <code>Father.vue</code> 触发父组件的事件执行</p></li></ol> <h3 id="下发-props"><a href="#下发-props" class="header-anchor">#</a> 下发 props</h3> <p>下发的过程是在 <code>Father.vue</code> 里完成的，父组件在向子组件下发 <code>props</code> 之前，需要导入子组件并启用它作为自身的模板，然后在 <code>setup</code> 里处理好数据，return 给 <code>template</code> 用。</p> <p>在 <code>Father.vue</code> 的 <code>script</code> 里：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'@cp/Child.vue'</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 需要启用子组件作为模板</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 定义一些数据并return给template用</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 不要忘记return，否则template拿不到数据</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userInfo
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后在 <code>Father.vue</code> 的 <code>template</code> 这边拿到 return 出来的数据，把要传递的数据通过属性的方式绑定在 <code>template</code> 的组件标签上。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span>
    <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>用户信息<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:uid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo.id<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">:user-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo.name<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这样就完成了 <code>props</code> 数据的下发。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>在 <code>template</code> 绑定属性这里，如果是普通的字符串，比如上面的 <code>title</code>，则直接给属性名赋值就可以</p></li> <li><p>如果是变量，或者其他类型如 <code>Number</code>、<code>Object</code> 等，则需要通过属性动态绑定的方式来添加，使用 <code>v-bind:</code> 或者 <code>:</code> 符号进行绑定</p></li> <li><p>官方建议 prop 在 <code>template</code> 统一采用短横线分隔命名 （详见：<a href="https://v3.cn.vuejs.org/guide/component-props.html#prop-%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%86%99%E5%91%BD%E5%90%8D-camelcase-vs-kebab-case" target="_blank" rel="noopener noreferrer">Prop 的大小写命名<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），但实际上你采用驼峰也是可以正确拿到值，因为 Vue 的源码里有做转换</p></li></ol></div> <h3 id="接收-props"><a href="#接收-props" class="header-anchor">#</a> 接收 props</h3> <p>接收的过程是在 <code>Child.vue</code> 里完成的，在 <code>script</code> 部分，子组件通过与 <code>setup</code> 同级的 <code>props</code> 来接收数据。</p> <p>它可以是一个数组，每个 <code>item</code> 都是 <code>String</code> 类型，把你要接受的变量名放到这个数组里，直接放进来作为数组的 <code>item</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'title'</span><span class="token punctuation">,</span>
    <span class="token string">'index'</span><span class="token punctuation">,</span>
    <span class="token string">'userName'</span><span class="token punctuation">,</span>
    <span class="token string">'uid'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>但这种情况下，使用者不知道这些属性到底是什么类型的值，是否必传。</p> <h3 id="带有类型限制的-props"><a href="#带有类型限制的-props" class="header-anchor">#</a> 带有类型限制的 props</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>既然我们最开始在决定使用 Vue 3.0 的时候，为了更好的类型限制，已经决定写 TypeScript ，那么我们最好不要出现这种使用情况。</p> <p><strong>推荐的方式是把 <code>props</code> 定义为一个对象，以对象形式列出 <code>prop</code>，每个 <code>property</code> 的名称和值分别是 <code>prop</code> 各自的名称和类型，只有合法的类型才允许传入。</strong></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>注意，和 TS 的类型定义不同， <code>props</code> 这里的类型，首字母需要大写。</p></div> <p>支持的类型有：</p> <table><thead><tr><th style="text-align:left;">类型</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">String</td> <td style="text-align:left;">字符串</td></tr> <tr><td style="text-align:left;">Number</td> <td style="text-align:left;">数值</td></tr> <tr><td style="text-align:left;">Boolean</td> <td style="text-align:left;">布尔值</td></tr> <tr><td style="text-align:left;">Array</td> <td style="text-align:left;">数组</td></tr> <tr><td style="text-align:left;">Object</td> <td style="text-align:left;">对象</td></tr> <tr><td style="text-align:left;">Date</td> <td style="text-align:left;">日期数据，e.g. new Date()</td></tr> <tr><td style="text-align:left;">Function</td> <td style="text-align:left;">函数，e.g. 普通函数、箭头函数、构造函数</td></tr> <tr><td style="text-align:left;">Promise</td> <td style="text-align:left;">Promise 类型的函数</td></tr> <tr><td style="text-align:left;">Symbol</td> <td style="text-align:left;">Symbol 类型的值</td></tr></tbody></table> <p>于是我们把 <code>props</code> 再改一下，加上类型限制：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    index<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
    uid<span class="token operator">:</span> Number
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这样我们如果传入不正确的类型，程序就会抛出警告信息，告知开发者必须正确传值。</p> <p>如果你需要对某个 <code>prop</code> 允许多类型，比如这个 <code>uid</code> 字段，它可能是数值，也可能是字符串，那么可以在类型这里，使用一个数组，把允许的类型都加进去。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 单类型</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    index<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    userName<span class="token operator">:</span> String<span class="token punctuation">,</span>

    <span class="token comment">// 这里使用了多种类型</span>
    uid<span class="token operator">:</span> <span class="token punctuation">[</span> Number<span class="token punctuation">,</span> String <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="可选以及带有默认值的-props"><a href="#可选以及带有默认值的-props" class="header-anchor">#</a> 可选以及带有默认值的 props</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>有时候我们想对一些 <code>prop</code> 设置为可选，然后提供一些默认值，还可以再将 <code>prop</code> 再进一步设置为对象，支持的字段有：</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">type</td> <td style="text-align:left;">string</td> <td style="text-align:left;">prop 的类型</td></tr> <tr><td style="text-align:left;">required</td> <td style="text-align:left;">boolean</td> <td style="text-align:left;">是否必传，true=必传，false=可选</td></tr> <tr><td style="text-align:left;">default</td> <td style="text-align:left;">any</td> <td style="text-align:left;">与 type 字段的类型相对应的默认值，如果 required 是 false ，但这里不设置默认值，则会默认为 <code>undefined</code></td></tr> <tr><td style="text-align:left;">validator</td> <td style="text-align:left;">function</td> <td style="text-align:left;">自定义验证函数，需要 return 一个布尔值，true=校验通过，false=校验不通过，当校验不通过时，控制台会抛出警告信息</td></tr></tbody></table> <p>我们现在再对 <code>props</code> 改造一下，对部分字段设置为可选，并提供默认值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 可选，并提供默认值</span>
    title<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> String<span class="token punctuation">,</span>
      required<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">'默认标题'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 默认可选，单类型</span>
    index<span class="token operator">:</span> Number<span class="token punctuation">,</span>

    <span class="token comment">// 添加一些自定义校验</span>
    userName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> String<span class="token punctuation">,</span>

      <span class="token comment">// 在这里校验用户名必须至少3个字</span>
      <span class="token function-variable function">validator</span><span class="token operator">:</span> v <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> <span class="token number">3</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 默认可选，但允许多种类型</span>
    uid<span class="token operator">:</span> <span class="token punctuation">[</span> Number<span class="token punctuation">,</span> String <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="使用-props"><a href="#使用-props" class="header-anchor">#</a> 使用 props</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>在 <code>template</code> 部分，3.x 的使用方法和 2.x 是一样的，比如要渲染我们上面传入的 <code>props</code> ：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>标题：{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>索引：{{ index }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>用户id：{{ uid }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>用户名：{{ userName }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><strong>但是 <code>script</code> 部分，变化非常大！</strong></p> <p>在 2.x ，只需要通过 <code>this.uid</code>、<code>this.userName</code> 就可以使用父组件传下来的 <code>prop</code> 。</p> <p>但是 3.x 没有了 <code>this</code>， 需要给 <code>setup</code> 添加一个入参才可以去操作。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    index<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
    uid<span class="token operator">:</span> Number
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 在这里需要添加一个入参</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 该入参包含了我们定义的所有props</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p><code>prop</code> 是只读，不允许修改</p></li> <li><p><code>setup</code> 的第一个入参，包含了我们定义的所有props（如果在 <code>Child.vue</code> 里未定义，但 父组件 <code>Father.vue</code> 那边非要传过来的，不会拿到，且控制台会有警告信息）</p></li> <li><p>该入参可以随意命名，比如你可以写成一个下划线 <code>_</code>，通过 <code>_.uid</code> 也可以拿到数据，但是语义化命名，是一个良好的编程习惯。</p></li></ol></div> <h3 id="传递非-prop-的-attribute"><a href="#传递非-prop-的-attribute" class="header-anchor">#</a> 传递非 Prop 的 Attribute</h3> <p>上面的提示里有提到一句：</p> <blockquote><p>如果在 <code>Child.vue</code> 里未定义，但 父组件 <code>Father.vue</code> 那边非要传过来的，不会拿到，且控制台会有警告信息</p></blockquote> <p>但并不意味着你不能传递任何未定义的属性数据，在父组件，除了可以给子组件绑定 props，你还可以根据实际需要去绑定一些特殊的属性。</p> <p>比如给子组件设置 <code>class</code>、<code>id</code>，或者 <code>data-xxx</code> 之类的一些自定义属性，<strong>如果 <code>Child.vue</code> 组件的 <code>template</code> 只有一个根节点，这些属性默认自动继承，并渲染在 node 节点上</strong>。</p> <p>在 <code>Father.vue</code> 里，对 <code>Child.vue</code> 传递了 <code>class</code>、<code>id</code> 和 <code>data-hash</code>：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">keys</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aaaa<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">data-hash</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afJasdHGUHa87d688723kjaghdhja<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>渲染后（2个 <code>data-v-xxx</code> 是父子组件各自的 <code>css scoped</code> 标记）：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">keys</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aaaa<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-hash</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afJasdHGUHa87d688723kjaghdhja<span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-v-2dcc19c8</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>
  <span class="token attr-name">data-v-7eb2bc79</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span>
<span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Child的内容 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>你可以在 <code>Child.vue</code> 配置 <code>inheritAttrs</code> 为 <code>false</code>，来屏蔽这些自定义属性的渲染。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  inheritAttrs<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...    </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="获取非-prop-的-attribute"><a href="#获取非-prop-的-attribute" class="header-anchor">#</a> 获取非 Prop 的 Attribute</h3> <p>想要拿到这些属性，原生操作需要通过 <code>element.getAttribute</code> ，但 Vue 也提供了相关的 API ：</p> <p>在 <code>Child.vue</code> 里，可以通过 <code>setup</code> 的第二个参数 <code>context</code> 里的 <code>attrs</code> 来获取到这些属性。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> attrs <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// attrs 是个对象，每个 Attribute 都是它的 key</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>attrs<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传下来的 Attribute 带有短横线，需要通过这种方式获取</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>attrs<span class="token punctuation">[</span><span class="token string">'data-hash'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p><code>attr</code> 和 <code>prop</code> 一样，都是只读的</p></li> <li><p>不管 <code>inheritAttrs</code> 是否设置，都可以通过 <code>attrs</code> 拿到这些数据，但是 <code>element.getAttribute</code> 则只有 <code>inheritAttrs</code> 为 <code>true</code> 的时候才可以。</p></li></ol></div> <p>Vue 3 的 <code>template</code> 还允许多个根节点，多个根节点的情况下，无法直接继承这些属性，需要在 <code>Child.vue</code> 指定继承在哪个节点上，否则会有警告信息。</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 指定继承 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-bind</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>attrs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 指定继承 --&gt;</span>
  
  <span class="token comment">&lt;!-- 这些不会自动继承 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 这些不会自动继承 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>当然，前提依然是，<code>setup</code> 里要把 <code>attrs</code> 给 <code>return</code> 出来。</p> <p>查看详情：<a href="https://v3.cn.vuejs.org/guide/component-attrs.html#%E5%A4%9A%E4%B8%AA%E6%A0%B9%E8%8A%82%E7%82%B9%E4%B8%8A%E7%9A%84-attribute-%E7%BB%A7%E6%89%BF" target="_blank" rel="noopener noreferrer">多个根节点上的 Attribute 继承<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="绑定-emits"><a href="#绑定-emits" class="header-anchor">#</a> 绑定 emits</h3> <p>最开始有介绍到，子组件如果需要向父组件告知数据更新，或者执行某些函数时，是通过 emits 来进行的。</p> <p>每个 <code>emit</code> 都是事件，所以需要先由父组件先给子组件绑定，子组件才能知道应该怎么去调用。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>当然，父组件也是需要先在 <code>setup</code> 里进行定义并 <code>return</code>，才能够在 <code>template</code> 里绑定给子组件。</p></div> <p>比如要给 <code>Child.vue</code> 绑定一个更新用户年龄的方法，那么在 <code>Father.vue</code> 里需要这么处理：</p> <p>先看 <code>script</code> 部分（留意注释部分）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'@cp/Child.vue'</span>

<span class="token keyword">interface</span> <span class="token class-name">Member</span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 定义一个更新年龄的方法</span>
    <span class="token keyword">const</span> updateAge <span class="token operator">=</span> <span class="token punctuation">(</span>age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      userInfo<span class="token punctuation">,</span>

      <span class="token comment">// return给template用</span>
      updateAge
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>再看 <code>template</code> 部分（为了方便阅读，我把之前绑定的 props 先去掉了）：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span>
    <span class="token attr-name">@update-age</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updateAge<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>动态绑定 <code>props</code> 是用 <code>:</code>，绑定 <code>emit</code> 是用 <code>@</code></p></li> <li><p>关于绑定的这个 <code>@</code> 符号，其实很好记忆，因为在 Vue 的 <code>template</code> 里，所有的事件绑定都是通过 <code>@</code>，比如 <code>@click</code>、<code>@change</code> 等等</p></li> <li><p>同样的，在绑定 <code>emit</code> 时，也需要使用短横线写法（详见：<a href="https://v3.cn.vuejs.org/guide/component-custom-events.html#%E4%BA%8B%E4%BB%B6%E5%90%8D" target="_blank" rel="noopener noreferrer">事件名<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p></li></ol></div> <h3 id="接收-emits"><a href="#接收-emits" class="header-anchor">#</a> 接收 emits</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>和 <code>props</code> 一样，你可以指定是一个数组，把要接收的 <code>emit</code> 名称写进去：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  emits<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'update-age'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>其实日常这样配置就足够用了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>这里的 <code>emit</code> 名称指 <code>Father.vue</code> 在给 <code>Child.vue</code> 绑定事件时，<code>template</code> 里面给子组件指定的 <code>@aaaaa=&quot;bbbbb&quot;</code> 里的 <code>aaaaa</code></p></li> <li><p>当在 emits 选项中定义了原生事件 (如 <code>click</code> ) 时，将使用组件中的事件替代原生事件侦听器</p></li></ol></div> <h3 id="接收-emits-时做一些校验"><a href="#接收-emits-时做一些校验" class="header-anchor">#</a> 接收 emits 时做一些校验</h3> <p>当然你也可以对这些事件做一些验证，配置为对象，然后把这个 <code>emit</code> 名称作为 <code>key</code>， <code>value</code> 则配置为一个方法。</p> <p>比如上面的更新年龄，只允许达到成年人的年龄才会去更新父组件的数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  emits<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 需要校验</span>
    <span class="token string-property property">'update-age'</span><span class="token operator">:</span> <span class="token punctuation">(</span>age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 写一些条件拦截，记得返回false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> age <span class="token operator">&lt;</span> <span class="token number">18</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'未成年人不允许参与'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 通过则返回true</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// 一些无需校验的，设置为null即可</span>
    <span class="token string-property property">'update-name'</span><span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="调用-emits"><a href="#调用-emits" class="header-anchor">#</a> 调用 emits</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>和 <code>props</code> 一样，也需要在 <code>setup</code> 的入参里引入 <code>emit</code> ，才允许操作。</p> <p><code>setup</code> 的第二个入参 <code>expose</code> 是一个对象，你可以完整导入 <code>expose</code> 然后通过 <code>expose.emit</code> 去操作，也可以按需导入 <code>{ emit }</code> （推荐这种方式）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  emits<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'update-age'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> emit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 2s 后更新年龄</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'update-age'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><code>emit</code> 的第二个参数开始是父组件那边要接收的自定义数据，为了开发上的便利，建议如果需要传多个数据的情况下，直接将第二个参数设置为一个对象，把所有数据都放到对象里，传递和接收起来都会方便很多。</p></div> <h2 id="v-model-emits"><a href="#v-model-emits" class="header-anchor">#</a> v-model / emits</h2> <p>对比 <code>props / emits</code> ，这个方式更为简单：</p> <ol><li><p>在 <code>Father.vue</code> ，通过 <code>v-model</code> 向 <code>Child.vue</code> 传值</p></li> <li><p><code>Child.vue</code> 通过自身设定的 emits 向 <code>Father.vue</code> 通知数据更新</p></li></ol> <p><code>v-model</code> 的用法和 <code>props</code> 非常相似，但是很多操作上更为简化，但操作简单带来的 “副作用” ，就是功能上也没有 <code>props</code> 那么多。</p> <h3 id="绑定-v-model"><a href="#绑定-v-model" class="header-anchor">#</a> 绑定 v-model</h3> <p>它的和下发 props 的方式类似，都是在子组件上绑定 <code>Father.vue</code> 定义好并 <code>return</code> 出来的数据。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <ol><li><p>和 2.x 不同， 3.x 可以直接绑定 <code>v-model</code> ，而无需在子组件指定 <code>model</code> 选项。</p></li> <li><p>另外，3.x 的 <code>v-model</code> 需要使用 <code>:</code> 来指定你要绑定的属性名，同时也开始支持绑定多个 <code>v-model</code></p></li></ol></div> <p>我们来看看具体的操作：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span>
    <span class="token attr-name"><span class="token namespace">v-model:</span>user-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo.name<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>如果你要绑定多个数据，写多个 <code>v-model</code> 即可</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span>
    <span class="token attr-name"><span class="token namespace">v-model:</span>user-name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo.name<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name"><span class="token namespace">v-model:</span>uid</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userInfo.id<span class="token punctuation">&quot;</span></span>
  <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>看到这里应该能明白了，一个 <code>v-model</code> 其实就是一个 <code>prop</code>，它支持的数据类型，和 <code>prop</code> 是一样的。</p> <p>所以，子组件在接收数据的时候，完全按照 <code>props</code> 去定义就可以了。</p> <p>点击回顾：<a href="#%E6%8E%A5%E6%94%B6-props">接收 props</a> ，了解在 <code>Child.vue</code> 如何接收 <code>props</code>，以及相关的 <code>props</code> 类型限制等部分内容。</p> <h3 id="配置-emits"><a href="#配置-emits" class="header-anchor">#</a> 配置 emits</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>虽然 <code>v-model</code> 的配置和 <code>prop</code> 相似，但是为什么出这么两个相似的东西？自然是为了简化一些开发上的操作。</p> <p>使用 props / emits，如果要更新父组件的数据，还需要在父组件定义好方法，然后 <code>return</code> 给 <code>template</code> 去绑定事件给子组件，才能够更新。</p> <p>而使用 <code>v-model / emits</code> ，无需如此，可以在 <code>Child.vue</code> 直接通过 “update:属性名” 的格式，直接定义一个更新事件：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  props<span class="token operator">:</span> <span class="token punctuation">{</span>
    userName<span class="token operator">:</span> String<span class="token punctuation">,</span>
    uid<span class="token operator">:</span> Number
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  emits<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'update:userName'</span><span class="token punctuation">,</span>
    <span class="token string">'update:uid'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这里的 update 后面的属性名，支持驼峰写法，这一部分和 2.x 的使用是相同的。</p> <p>这里也可以对数据更新做一些校验，配置方式和 <a href="#%E6%8E%A5%E6%94%B6-emits-%E6%97%B6%E5%81%9A%E4%B8%80%E4%BA%9B%E6%A0%A1%E9%AA%8C">接收 emits 时做一些校验</a> 是一样的。</p> <h3 id="调用自身的-emits"><a href="#调用自身的-emits" class="header-anchor">#</a> 调用自身的 emits</h3> <blockquote><p>注：这一小节的步骤是在 <code>Child.vue</code> 里操作。</p></blockquote> <p>在 <code>Child.vue</code> 配置好 emits 之后，就可以在 <code>setup</code> 里直接操作数据的更新了：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> emit <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 2s 后更新用户名</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'update:userName'</span><span class="token punctuation">,</span> <span class="token string">'Tom'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在使用上，和 <a href="#%E8%B0%83%E7%94%A8-emits-new">调用 emits</a> 是一样的。</p> <h2 id="ref-emits"><a href="#ref-emits" class="header-anchor">#</a> ref / emits</h2> <h3 id="父组件操作子组件"><a href="#父组件操作子组件" class="header-anchor">#</a> 父组件操作子组件</h3> <p>父组件也可以直接通过对子组件绑定 <code>ref</code> 属性，然后通过 ref 变量去操作子组件的数据或者调用里面的方法。</p> <p>比如导入了一个 <code>Child.vue</code> 作为子组件，需要在 <code>template</code> 处给子组件标签绑定 <code>ref</code>：</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Child</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>child<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>然后在 <code>script</code> 部分定义好对应的变量名称（记得要 <code>return</code> 出来）：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> Child <span class="token keyword">from</span> <span class="token string">'@cp/Child.vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  components<span class="token operator">:</span> <span class="token punctuation">{</span>
    Child
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 给子组件定义一个ref变量</span>
    <span class="token keyword">const</span> child <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>HTMLElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 请保证视图渲染完毕后再执行操作</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 执行子组件里面的ajax函数</span>
      child<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 打开子组件里面的弹窗</span>
      child<span class="token punctuation">.</span>value<span class="token punctuation">.</span>isShowDialog <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 必须return出去才可以给到template使用</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      child
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="子组件通知父组件"><a href="#子组件通知父组件" class="header-anchor">#</a> 子组件通知父组件</h3> <p>子组件如果想主动向父组件通讯，也需要使用 <code>emit</code>，详细的配置方法可见：<a href="#%E7%BB%91%E5%AE%9A-emits-new">绑定 emits</a></p> <h2 id="爷孙组件通信"><a href="#爷孙组件通信" class="header-anchor">#</a> 爷孙组件通信</h2> <p>顾名思义，爷孙组件是比 <a href="#%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">父子组件通信</a> 要更深层次的引用关系（也有称之为 “隔代组件”）：</p> <p>C组件引入到B组件里，B组件引入到A组件里渲染，此时A是C的爷爷级别（可能还有更多层级关系），如果你用 <code>props</code> ，只能一级一级传递下去，那就太繁琐了，因此我们需要更直接的通信方式。</p> <p>他们之间的关系如下，<code>Grandson.vue</code> 并非直接挂载在 <code>Grandfather.vue</code> 下面，他们之间还隔着至少一个 <code>Son.vue</code> （可能有多个）：</p> <div class="language- extra-class"><pre class="language-text"><code>Grandfather.vue
└─Son.vue
  └─Grandson.vue
</code></pre></div><p>这一 Part 就是讲一讲 C 和 A 之间的数据传递，常用的方法有：</p> <table><thead><tr><th style="text-align:left;">方案</th> <th style="text-align:left;">爷组件向孙组件</th> <th style="text-align:left;">孙组件向爷组件</th> <th style="text-align:left;">对应章节传送门</th></tr></thead> <tbody><tr><td style="text-align:left;">provide / inject</td> <td style="text-align:left;">provide</td> <td style="text-align:left;">inject</td> <td style="text-align:left;"><a href="#provide-inject">点击查看</a></td></tr> <tr><td style="text-align:left;">EventBus</td> <td style="text-align:left;">emit / on</td> <td style="text-align:left;">emit / on</td> <td style="text-align:left;"><a href="#eventbus-new">点击查看</a></td></tr> <tr><td style="text-align:left;">Vuex</td> <td style="text-align:left;">-</td> <td style="text-align:left;">-</td> <td style="text-align:left;"><a href="#vuex-new">点击查看</a></td></tr></tbody></table> <p>为了方便阅读，下面的父组件统一叫 <code>Grandfather.vue</code>，子组件统一叫 <code>Grandson.vue</code>，但实际上他们之间可以隔无数代…</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>因为上下级的关系的一致性，爷孙组件通信的方案也适用于 <a href="#%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">父子组件通信</a> ，只需要把爷孙关系换成父子关系即可。</p></div> <h2 id="provide-inject"><a href="#provide-inject" class="header-anchor">#</a> provide / inject</h2> <p>这个特性有两个部分：<code>Grandfather.vue</code> 有一个 <code>provide</code> 选项来提供数据，<code>Grandson.vue</code> 有一个 <code>inject</code> 选项来开始使用这些数据。</p> <ol><li><p><code>Grandfather.vue</code> 通过 <code>provide</code> 向 <code>Grandson.vue</code> 传值（可包含定义好的函数）</p></li> <li><p><code>Grandson.vue</code> 通过 <code>inject</code> 向 <code>Grandfather.vue</code> 触发爷爷组件的事件执行</p></li></ol> <p>无论组件层次结构有多深，发起 <code>provide</code> 的组件都可以作为其所有下级组件的依赖提供者。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这一部分的内容变化都特别大，但使用起来其实也很简单，不用慌，也有相同的地方：</p> <ol><li><p>父组件不需要知道哪些子组件使用它 provide 的 property</p></li> <li><p>子组件不需要知道 inject property 来自哪里</p></li></ol> <p>另外，要切记一点就是：provide 和 inject 绑定并不是可响应的。这是刻意为之的，但如果传入了一个可监听的对象，那么其对象的 property 还是可响应的。</p></div> <h3 id="发起-provide"><a href="#发起-provide" class="header-anchor">#</a> 发起 provide</h3> <p>我们先来回顾一下 2.x 的用法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义好数据</span>
  <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      tags<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'中餐'</span><span class="token punctuation">,</span> <span class="token string">'粤菜'</span><span class="token punctuation">,</span> <span class="token string">'烧腊'</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// provide出去</span>
  <span class="token function">provide</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      tags<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tags
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>旧版的 <code>provide</code> 用法和 <code>data</code> 类似，都是配置为一个返回对象的函数。</p> <p>3.x 的新版 <code>provide</code>， 和 2.x 的用法区别比较大。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在 3.x ， <code>provide</code> 需要导入并在 <code>setup</code> 里启用，并且现在是一个全新的方法。</p> <p>每次要 <code>provide</code> 一个数据的时候，就要单独调用一次。</p></div> <p>每次调用的时候，都需要传入 2 个参数：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">key</td> <td style="text-align:left;">string</td> <td style="text-align:left;">数据的名称</td></tr> <tr><td style="text-align:left;">value</td> <td style="text-align:left;">any</td> <td style="text-align:left;">数据的值</td></tr></tbody></table> <p>来看一下如何创建一个 <code>provide</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 记得导入provide</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> provide <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义好数据</span>
    <span class="token keyword">const</span> msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">;</span>

    <span class="token comment">// provide出去</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>操作非常简单对吧哈哈哈，但需要注意的是，<code>provide</code> 不是响应式的，如果你要使其具备响应性，你需要传入响应式数据，详见：<a href="#%E5%93%8D%E5%BA%94%E6%80%A7%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BC%A0%E9%80%92%E4%B8%8E%E6%8E%A5%E6%94%B6-new">响应性数据的传递与接收</a></p> <h3 id="接收-inject"><a href="#接收-inject" class="header-anchor">#</a> 接收 inject</h3> <p>也是先来回顾一下 2.x 的用法：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">'tags'</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>旧版的 <code>inject</code> 用法和 <code>props</code> 类似，3.x 的新版 <code>inject</code>， 和 2.x 的用法区别也是比较大。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在 3.x， <code>inject</code> 和 <code>provide</code> 一样，也是需要先导入然后在 <code>setup</code> 里启用，也是一个全新的方法。</p> <p>每次要 <code>inject</code> 一个数据的时候，就要单独调用一次。</p></div> <p>每次调用的时候，只需要传入 1 个参数：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">key</td> <td style="text-align:left;">string</td> <td style="text-align:left;">与 <code>provide</code> 相对应的数据名称</td></tr></tbody></table> <p>来看一下如何创建一个 <code>inject</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 记得导入inject</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> inject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>也是很简单（写 TS 的话，由于 <code>inject</code> 到的值可能是 <code>undefined</code>，所以要么加个 <code>undefined</code> 类型，要么给变量设置一个空的默认值）。</p> <h3 id="响应性数据的传递与接收"><a href="#响应性数据的传递与接收" class="header-anchor">#</a> 响应性数据的传递与接收</h3> <p>之所以要单独拿出来说， 是因为变化真的很大 - -</p> <p>在前面我们已经知道，provide 和 inject 本身不可响应，但是并非完全不能够拿到响应的结果，只需要我们传入的数据具备响应性，它依然能够提供响应支持。</p> <p>我们以 <code>ref</code> 和 <code>reactive</code> 为例，来看看应该怎么发起 <code>provide</code> 和接收 <code>inject</code>。</p> <p>先在 <code>Grandfather.vue</code> 里 <code>provide</code> 数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// provide一个ref</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// provide一个reactive</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s 后更新数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 修改消息内容</span>
      msg<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'Hi World!'</span><span class="token punctuation">;</span>

      <span class="token comment">// 修改用户名</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在 <code>Grandsun.vue</code> 里 <code>inject</code> 拿到数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取数据</span>
    <span class="token keyword">const</span> msg <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'msg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印刚刚拿到的数据</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为 2s 后数据会变，我们 3s 后再看下，可以争取拿到新的数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 响应式数据还可以直接给 template 使用，会实时更新</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      msg<span class="token punctuation">,</span>
      userInfo
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>非常简单，非常方便！！！</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>响应式的数据 <code>provide</code> 出去，在子孙组件拿到的也是响应式的，并且可以如同自身定义的响应式变量一样，直接 <code>return</code> 给 <code>template</code> 使用，一旦数据有变化，视图也会立即更新。</p> <p>但上面这句话有效的前提是，不破坏数据的响应性，比如 ref 变量，你需要完整的传入，而不能只传入它的 <code>value</code>，对于 <code>reactive</code> 也是同理，不能直接解构去破坏原本的响应性。</p> <p>切记！切记！！！</p></div> <h3 id="引用类型的传递与接收"><a href="#引用类型的传递与接收" class="header-anchor">#</a> 引用类型的传递与接收</h3> <blockquote><p>这里是针对非响应性数据的处理</p></blockquote> <p>provide 和 inject 并不是可响应的，这是官方的故意设计，但是由于引用类型的特殊性，在子孙组件拿到了数据之后，他们的属性还是可以正常的响应变化。</p> <p>先在 <code>Grandfather.vue</code> 里 <code>provide</code> 数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// provide 一个数组</span>
    <span class="token keyword">const</span> tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'中餐'</span><span class="token punctuation">,</span> <span class="token string">'粤菜'</span><span class="token punctuation">,</span> <span class="token string">'烧腊'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'tags'</span><span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// provide 一个对象</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">'Petter'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">,</span> userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s 后更新数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 增加tags的长度</span>
      tags<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'叉烧'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 修改userInfo的属性值</span>
      userInfo<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在 <code>Grandsun.vue</code> 里 <code>inject</code> 拿到数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取数据</span>
    <span class="token keyword">const</span> tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'tags'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> userInfo<span class="token operator">:</span> Member <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'userInfo'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印刚刚拿到的数据</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为 2s 后数据会变，我们 3s 后再看下，能够看到已经是更新后的数据了</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>引用类型的数据，拿到后可以直接用，属性的值更新后，子孙组件也会被更新。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>由于不具备真正的响应性，<code>return</code> 给模板使用依然不会更新视图，如果涉及到视图的数据，请依然使用 <a href="/document/component.html#响应式数据的变化-new">响应式 API</a> 。</p></div> <h3 id="基本类型的传递与接收"><a href="#基本类型的传递与接收" class="header-anchor">#</a> 基本类型的传递与接收</h3> <blockquote><p>这里是针对非响应性数据的处理</p></blockquote> <p>基本数据类型被直接 <code>provide</code> 出去后，再怎么修改，都无法更新下去，子孙组件拿到的永远是第一次的那个值。</p> <p>先在 <code>Grandfather.vue</code> 里 <code>provide</code> 数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// provide 一个数组的长度</span>
    <span class="token keyword">const</span> tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'中餐'</span><span class="token punctuation">,</span> <span class="token string">'粤菜'</span><span class="token punctuation">,</span> <span class="token string">'烧腊'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'tagsCount'</span><span class="token punctuation">,</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// provide 一个字符串</span>
    <span class="token keyword">let</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Petter'</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s 后更新数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// tagsCount 在 Grandson 那边依然是 3</span>
      tags<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'叉烧'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// name 在 Grandson 那边依然是 Petter</span>
      name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在 <code>Grandsun.vue</code> 里 <code>inject</code> 拿到数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取数据</span>
    <span class="token keyword">const</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tagsCount<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'tagsCount'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印刚刚拿到的数据</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tagsCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为 2s 后数据会变，我们 3s 后再看下</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 依然是 Petter</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 依然是 3</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tagsCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>很失望，并没有变化。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>那么是否一定要定义成响应式数据或者引用类型数据呢？</p> <p>当然不是，我们在 <code>provide</code> 的时候，也可以稍作修改，让它能够同步更新下去。</p></div> <p>我们再来一次，依然是先在 <code>Grandfather.vue</code> 里 <code>provide</code> 数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// provide 一个数组的长度</span>
    <span class="token keyword">const</span> tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'中餐'</span><span class="token punctuation">,</span> <span class="token string">'粤菜'</span><span class="token punctuation">,</span> <span class="token string">'烧腊'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'tagsCount'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// provide 字符串</span>
    <span class="token keyword">let</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Petter'</span><span class="token punctuation">;</span>
    <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2s 后更新数据</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// tagsCount 现在可以正常拿到 4 了</span>
      tags<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'叉烧'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// name 现在可以正常拿到 Tom 了</span>
      name <span class="token operator">=</span> <span class="token string">'Tom'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>再来 <code>Grandsun.vue</code> 里修改一下 <code>inject</code> 的方式，看看这次拿到的数据：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取数据</span>
    <span class="token keyword">const</span> tagsCount<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'tagsCount'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 打印刚刚拿到的数据</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">tagsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 因为 2s 后数据会变，我们 3s 后再看下</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 现在可以正确得到 4</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">tagsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 现在可以正确得到 Tom</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这次可以正确拿到数据了，看出这2次的写法有什么区别了吗？</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>基本数据类型，需要 <code>provide</code> 一个函数，将其 <code>return</code> 出去给子孙组件用，这样子孙组件每次拿到的数据才会是新的。</p> <p>但由于不具备响应性，所以子孙组件每次都需要重新通过执行 <code>inject</code> 得到的函数才能拿到最新的数据。</p></div> <p>按我个人习惯来说，使用起来挺别扭的，能不用就不用……</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>由于不具备真正的响应性，<code>return</code> 给模板使用依然不会更新视图，如果涉及到视图的数据，请依然使用 <a href="/document/component.html#响应式数据的变化-new">响应式 API</a> 。</p></div> <h2 id="兄弟组件通信"><a href="#兄弟组件通信" class="header-anchor">#</a> 兄弟组件通信</h2> <p>兄弟组件是指两个组件都挂载在同一个 <code>Father.vue</code> 下，但两个组件之间并没有什么直接的关联，先看看他们的关系：</p> <div class="language- extra-class"><pre class="language-text"><code>Father.vue
├─Brother.vue
└─LittleBrother.vue
</code></pre></div><p>既然没有什么直接关联， ╮(╯▽╰)╭ 所以也没有什么专属于他们的通信方式。</p> <p>如果他们之间要交流，目前大概有这两类选择：</p> <ol><li><p>【不推荐】先把数据传给 <code>Father.vue</code>，再通过 <a href="#%E7%88%B6%E5%AD%90%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">父子组件通信</a> 的方案去交流</p></li> <li><p>【推荐】借助 <a href="#%E5%85%A8%E5%B1%80%E7%BB%84%E4%BB%B6%E9%80%9A%E4%BF%A1">全局组件通信</a> 的方案才能达到目的。</p></li></ol> <h2 id="全局组件通信"><a href="#全局组件通信" class="header-anchor">#</a> 全局组件通信</h2> <p>全局组件通信是指，两个任意的组件，不管是否有关联（e.g. 父子、爷孙）的组件，都可以直接进行交流的通信方案。</p> <p>举个例子，像下面这样，<code>B2.vue</code> 可以采用全局通信方案，直接向 <code>D2.vue</code> 发起交流，而无需经过他们的父组件。</p> <div class="language- extra-class"><pre class="language-text"><code>A.vue
├─B1.vue
├───C1.vue
├─────D1.vue
├─────D2.vue
├───C2.vue
├─────D3.vue
└─B2.vue
</code></pre></div><p>常用的方法有：</p> <table><thead><tr><th style="text-align:left;">方案</th> <th style="text-align:left;">发起方</th> <th style="text-align:left;">接收方</th> <th style="text-align:left;">对应章节传送门</th></tr></thead> <tbody><tr><td style="text-align:left;">EventBus</td> <td style="text-align:left;">emit</td> <td style="text-align:left;">on</td> <td style="text-align:left;"><a href="#eventbus-new">点击查看</a></td></tr> <tr><td style="text-align:left;">Vuex</td> <td style="text-align:left;">-</td> <td style="text-align:left;">-</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">Pinia</td> <td style="text-align:left;">-</td> <td style="text-align:left;">-</td> <td style="text-align:left;">-</td></tr></tbody></table> <h2 id="eventbus"><a href="#eventbus" class="header-anchor">#</a> EventBus</h2> <p><code>EventBus</code> 通常被称之为 “全局事件总线” ，它是用来在全局范围内通信的一个常用方案，它的特点就是： “简单” 、 “灵活” 、“轻量级”。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>在中小型项目，全局通信推荐优先采用该方案，事件总线在打包压缩后不到 200 个字节， API 也非常简单和灵活。</p></div> <h3 id="回顾-vue-2-3"><a href="#回顾-vue-2-3" class="header-anchor">#</a> 回顾 Vue 2</h3> <p>在 2.x，使用 EventBus 无需导入第三方插件，直接在自己的 <code>libs</code> 文件夹下创建一个 <code>bus.ts</code> 文件，暴露一个新的 Vue 实例即可。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">;</span>
</code></pre></div><p>然后就可以在组件里引入 bus ，通过 <code>$emit</code> 去发起交流，通过 <code>$on</code> 去监听接收交流。</p> <p>旧版方案的完整案例代码可以查看官方的 <a href="https://v3.cn.vuejs.org/guide/migration/events-api.html#_2-x-%E8%AF%AD%E6%B3%95" target="_blank" rel="noopener noreferrer">2.x 语法 - 事件 API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="了解-vue-3-3"><a href="#了解-vue-3-3" class="header-anchor">#</a> 了解 Vue 3</h3> <p>Vue 3 移除了 <code>$on</code> 、 <code>$off</code> 和 <code>$once</code> 这几个事件 API ，应用实例不再实现事件触发接口。</p> <p>根据官方文档在 <a href="https://v3.cn.vuejs.org/guide/migration/events-api.html#%E8%BF%81%E7%A7%BB%E7%AD%96%E7%95%A5" target="_blank" rel="noopener noreferrer">迁移策略 - 事件 API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的推荐，我们可以用 <a href="https://github.com/developit/mitt" target="_blank" rel="noopener noreferrer">mitt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <a href="https://github.com/scottcorgan/tiny-emitter" target="_blank" rel="noopener noreferrer">tiny-emitter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 等第三方插件来实现 <code>EventBus</code> 。</p> <h3 id="创建-3-x-的-eventbus"><a href="#创建-3-x-的-eventbus" class="header-anchor">#</a> 创建 3.x 的 EventBus</h3> <p>这里以 <code>mitt</code> 为例，示范如何创建一个 Vue 3 的 <code>EventBus</code> 。</p> <p>首先，需要安装 <code>mitt</code> ：</p> <div class="language- extra-class"><pre class="language-text"><code>npm install --save mitt
</code></pre></div><p>然后在 <code>libs</code> 文件夹下，创建一个 <code>bus.ts</code> 文件，内容和旧版写法其实是一样的，只不过是把 Vue 实例，换成了 mitt 实例。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> mitt<span class="token punctuation">,</span> <span class="token punctuation">{</span> Emitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'mitt'</span>
<span class="token keyword">type</span> <span class="token class-name">Events</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  sayHi<span class="token operator">:</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> mitter<span class="token operator">:</span> Emitter<span class="token operator">&lt;</span>Events<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">mitt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> mitter
</code></pre></div><p>然后就可以定义发起和接收的相关事件了，常用的 API 和参数如下：</p> <table><thead><tr><th style="text-align:left;">方法名称</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">on</td> <td style="text-align:left;">注册一个监听事件，用于接收数据</td></tr> <tr><td style="text-align:left;">emit</td> <td style="text-align:left;">调用方法发起数据传递</td></tr> <tr><td style="text-align:left;">off</td> <td style="text-align:left;">用来移除监听事件</td></tr></tbody></table> <p><code>on</code> 的参数：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">type</td> <td style="text-align:left;">string | symbol</td> <td style="text-align:left;">方法名</td></tr> <tr><td style="text-align:left;">handler</td> <td style="text-align:left;">function</td> <td style="text-align:left;">接收到数据之后要做什么处理的回调函数</td></tr></tbody></table> <p>这里的 <code>handler</code> 建议使用具名函数，因为匿名函数无法销毁。</p> <p><code>emit</code> 的参数：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">type</td> <td style="text-align:left;">string | symbol</td> <td style="text-align:left;">与 on 对应的方法名</td></tr> <tr><td style="text-align:left;">data</td> <td style="text-align:left;">any</td> <td style="text-align:left;">与 on 对应的，允许接收的数据</td></tr></tbody></table> <p><code>off</code> 的参数：</p> <table><thead><tr><th style="text-align:left;">参数</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">作用</th></tr></thead> <tbody><tr><td style="text-align:left;">type</td> <td style="text-align:left;">string | symbol</td> <td style="text-align:left;">与 on 对应的方法名</td></tr> <tr><td style="text-align:left;">handler</td> <td style="text-align:left;">function</td> <td style="text-align:left;">要删除的，与 on 对应的 handler 函数名</td></tr></tbody></table> <p>更多的 API 可以查阅 <a href="https://github.com/developit/mitt" target="_blank" rel="noopener noreferrer">插件的官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，在了解了最基本的用法之后，我们来开始配置一对交流。</p> <h3 id="创建和移除监听事件"><a href="#创建和移除监听事件" class="header-anchor">#</a> 创建和移除监听事件</h3> <p>在需要暴露交流事件的组件里，通过 <code>on</code> 配置好接收方法，同时为了避免路由切换过程中造成事件多次被绑定，多次触发，需要在适当的时机 <code>off</code> 掉：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent<span class="token punctuation">,</span> onBeforeUnmount <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> bus <span class="token keyword">from</span> <span class="token string">'@libs/bus'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义一个打招呼的方法</span>
    <span class="token keyword">const</span> sayHi <span class="token operator">=</span> <span class="token punctuation">(</span>msg<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'Hello World!'</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 启用监听</span>
    bus<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'sayHi'</span><span class="token punctuation">,</span> sayHi<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 在组件卸载之前移除监听</span>
    <span class="token function">onBeforeUnmount</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      bus<span class="token punctuation">.</span><span class="token function">off</span><span class="token punctuation">(</span><span class="token string">'sayHi'</span><span class="token punctuation">,</span> sayHi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="调用监听事件"><a href="#调用监听事件" class="header-anchor">#</a> 调用监听事件</h3> <p>在需要调用交流事件的组件里，通过 <code>emit</code> 进行调用：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> defineComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> bus <span class="token keyword">from</span> <span class="token string">'@libs/bus'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">setup</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用打招呼事件，传入消息内容</span>
    bus<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sayHi'</span><span class="token punctuation">,</span> <span class="token string">'哈哈哈哈哈哈哈哈哈哈哈哈哈哈'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="旧项目升级-eventbus"><a href="#旧项目升级-eventbus" class="header-anchor">#</a> 旧项目升级 EventBus</h3> <p>在 <a href="#%E5%88%9B%E5%BB%BA-3-x-%E7%9A%84-eventbus-new">Vue 3 的 EventBus</a>，我们可以看到它的 API 和旧版是非常接近的，只是去掉了 <code>$</code> 符号。</p> <p>如果你要对旧的项目进行升级改造，因为原来都是使用了 <code>$on</code> 、 <code>$emit</code> 等旧的 API ，一个一个组件去修改成新的 API 肯定不现实。</p> <p>我们可以在创建 <code>bus.ts</code> 的时候，通过自定义一个 <code>bus</code> 对象，来挂载 <code>mitt</code> 的 API 。</p> <p>在 <code>bus.ts</code> 里，改成以下代码：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> mitt <span class="token keyword">from</span> <span class="token string">'mitt'</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化一个 mitt 实例</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token function">mitt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个空对象用来承载我们的自定义方法</span>
<span class="token keyword">const</span> bus<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 把你要用到的方法添加到 bus 对象上</span>
bus<span class="token punctuation">.</span>$on <span class="token operator">=</span> emitter<span class="token punctuation">.</span>on<span class="token punctuation">;</span>
bus<span class="token punctuation">.</span>$emit <span class="token operator">=</span> emitter<span class="token punctuation">.</span>emit<span class="token punctuation">;</span>

<span class="token comment">// 最终是暴露自己定义的 bus</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> bus<span class="token punctuation">;</span>
</code></pre></div><p>这样我们在组件里就可以继续使用 <code>bus.$on</code> 、<code>bus.$emit</code> 等以前的老 API 了，不影响我们旧项目的升级使用。</p> <h2 id="全局-api-的转移"><a href="#全局-api-的转移" class="header-anchor">#</a> 全局 API 的转移</h2> <ul><li><p>Vue 2.x 有许多全局 API 和配置。</p> <ul><li><p>例如：注册全局组件、注册全局指令等。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//注册全局组件</span>
Vue<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'MyButton'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">data</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'&lt;button @click=&quot;count++&quot;&gt;Clicked {{ count }} times.&lt;/button&gt;'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">//注册全局指令</span>
Vue<span class="token punctuation">.</span><span class="token function">directive</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">inserted</span><span class="token operator">:</span> <span class="token parameter">el</span> <span class="token operator">=&gt;</span> el<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>Vue3.0 中对这些 API 做出了调整：</p> <ul><li><p>将全局的 API，即：<code>Vue.xxx</code>调整到应用实例（<code>app</code>）上</p> <table><thead><tr><th>2.x 全局 API（<code>Vue</code>）</th> <th>3.x 实例 API (<code>app</code>)</th></tr></thead> <tbody><tr><td>Vue.config.xxxx</td> <td>app.config.xxxx</td></tr> <tr><td>Vue.config.productionTip</td> <td><strong style="color:#DD5145;">移除</strong></td></tr> <tr><td>Vue.component</td> <td>app.component</td></tr> <tr><td>Vue.directive</td> <td>app.directive</td></tr> <tr><td>Vue.mixin</td> <td>app.mixin</td></tr> <tr><td>Vue.use</td> <td>app.use</td></tr> <tr><td>Vue.prototype</td> <td>app.config.globalProperties</td></tr></tbody></table></li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/document/TypeScript.html" class="prev">
        TypeScript
      </a></span> <span class="next"><a href="/document/x6/">
        antv-X6
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.49d1029a.js" defer></script><script src="/assets/js/2.2784263e.js" defer></script><script src="/assets/js/39.9ec52d5d.js" defer></script>
  </body>
</html>
